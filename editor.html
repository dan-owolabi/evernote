<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíê Bouquet Editor [v3.1-FIXED]</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Kalam:wght@300;400;700&family=Caveat:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Kalam:wght@300;400;700&family=Caveat:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons inlined as SVGs -->
    <style>
        :root {
            --primary: #c9184a;
            --primary-light: #ff4d6d;
            --bg-workspace: #f5f5f5;
            --panel-bg: rgba(255, 255, 255, 0.7);
            --border: rgba(0, 0, 0, 0.08);
            --text-main: #1a1a1c;
            --text-secondary: #86868b;
            --nav-h: 64px;
            --sidebar-w: 300px;
            --accent: #8d8d95;
            --cursor-arrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 14 14'%3E%3Cpath fill='white' stroke='%234e4e4e' stroke-width='0.5' fill-rule='evenodd' d='M13.748 4.973c0-.256-.144-.456-.244-.572a2.6 2.6 0 0 0-.428-.38c-.33-.244-.786-.51-1.315-.78c-1.061-.543-2.48-1.14-3.936-1.655C6.37 1.072 4.858.632 3.61.408C2.988.297 2.412.236 1.932.253C1.483.27.99.358.672.674C.356.992.27 1.487.255 1.934c-.015.48.048 1.057.163 1.679c.229 1.247.676 2.76 1.197 4.214c.522 1.456 1.124 2.875 1.672 3.937c.273.529.54.985.784 1.315c.12.163.248.313.38.427c.116.1.315.244.572.244c.332 0 .603-.16.806-.35c.2-.19.368-.438.51-.701c.287-.528.526-1.218.725-1.903c.201-.691.37-1.407.505-1.998l.043-.188c.078-.34.141-.616.192-.813c.194-.05.465-.115.8-.194l.199-.047c.59-.14 1.306-.313 1.997-.52c.684-.204 1.374-.448 1.9-.739a2.8 2.8 0 0 0 .7-.517c.19-.203.349-.475.349-.807' clip-rule='evenodd'/%3E%3C/svg%3E") 1 1, auto;
            --cursor-drag: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24'%3E%3Crect x='2.5' y='2.5' width='19' height='19' rx='9.5' fill='white' stroke='%234e4e4e' stroke-width='0.5'/%3E%3Cg fill='none' stroke='%234e4e4e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.1'%3E%3Cpath d='M8 11V7.5a1.5 1.5 0 0 1 3 0V10m0-.5v-3a1.5 1.5 0 0 1 3 0V10m0-2.5a1.5 1.5 0 0 1 3 0V10'/%3E%3Cpath d='M17 9.5a1.5 1.5 0 0 1 3 0V14a6 6 0 0 1-6 6h-2h.208a6 6 0 0 1-5.012-2.7L7 17q-.468-.718-3.286-5.728A1.5 1.5 0 0 1 4.25 9.25a1.87 1.87 0 0 1 2.28.28L8 11'/%3E%3C/g%3E%3C/svg%3E") 11 11, grab;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-workspace);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: var(--cursor-arrow);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê TOP NAVIGATION √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê FLOATING CONTROLS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .floating-add-btn {
            position: fixed;
            top: 24px;
            left: 24px;
            width: 72px;
            height: 72px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: 980px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-add-btn:hover {
            transform: scale(1.05);
            background: #fff;
        }

        .floating-add-btn i {
            font-size: 24px;
            color: var(--text-main);
        }

        .floating-nav-tools {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            height: 44px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: 980px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 980px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-main);
        }

        button {
            cursor: var(--cursor-arrow);
        }

        button:hover {
            cursor: var(--cursor-drag), pointer;
        }

        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .nav-btn i {
            font-size: 18px;
        }

        .floating-nav-tools.right {
            left: auto;
            right: 24px;
            transform: none;
            gap: 12px;
        }

        .save-btn {
            background: var(--text-main);
            color: #fff;
            padding: 0 18px;
            height: 36px;
            border-radius: 980px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê FLOATING STYLES PANEL √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .floating-styles-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: 980px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-styles-btn:hover {
            transform: scale(1.05);
            background: #fff;
        }

        .floating-styles-btn i {
            font-size: 20px;
            color: var(--text-main);
        }

        .styles-menu {
            position: fixed;
            bottom: 84px;
            right: 24px;
            width: 280px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            display: none;
            flex-direction: column;
            padding: 20px;
            z-index: 3000;
            animation: menuEntry 0.3s ease-out;
        }

        .styles-menu.active {
            display: flex;
        }

        .style-section {
            margin-bottom: 20px;
        }

        .style-section:last-child {
            margin-bottom: 0;
        }

        .style-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 12px;
            display: block;
        }

        /* Removed Sidebar & Legacy Styles */


        .color-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-dot:hover {
            transform: scale(1.1);
        }

        .color-dot.active {
            border-color: var(--text-main);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê ADD MENU (Ultra-Minimal) √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .add-menu {
            position: fixed;
            top: 86px;
            left: 24px;
            width: 420px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid var(--border);
            border-radius: 32px;
            box-shadow: 0 30px 90px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            padding: 24px;
            z-index: 5000;
            animation: menuEntry 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes menuEntry {
            from {
                transform: translateY(-20px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .add-menu.active {
            display: flex;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê LETTER REDESIGN (The Ife Card) √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .letter-editor-fullscreen {
            width: 45vw;
            min-width: 500px;
            height: 92vh;
            border-radius: 24px;
            padding: 48px 32px 32px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.3);
            animation: letterSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .letter-paper-card {
            width: 100%;
            flex: 1;
            background: #fff0f5;
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.4) 0%, transparent 100%);
            border-radius: 20px;
            padding: 40px 32px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 182, 193, 0.3);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .letter-modal-card {
            width: 480px;
            background: #fff0f5;
            /* Light blush base */
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.4) 0%, transparent 100%);
            border-radius: 20px;
            padding: 40px 32px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: visible;
        }

        .letter-modal-card .texture {
            position: absolute;
            inset: 0;
            opacity: 0.05;
            pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            border-radius: 20px;
        }

        .letter-paper-card .texture {
            position: absolute;
            inset: 0;
            opacity: 0.05;
            pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            border-radius: 20px;
        }

        .letter-textarea {
            width: 100%;
            min-height: 200px;
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Kalam', cursive;
            font-size: 18px;
            line-height: 1.6;
            color: #4b2c34;
            text-align: center;
            resize: none;
            z-index: 2;
            position: relative;
        }

        .love-sticker-modal {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: rotate(15deg);
            z-index: 5;
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            color: #ff4d6d;
            font-style: italic;
            border: 2px dashed #f8bbd0;
        }

        .badge-container {
            position: absolute;
            bottom: -20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .pill-badge {
            background: #fff;
            padding: 4px 12px;
            border-radius: 980px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .pill-badge.blue {
            color: #2196f3;
        }

        .pill-badge.orange {
            color: #ff9800;
        }

        .pill-badge.pink {
            color: #e91e63;
        }

        .portrait-card {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 14px;
            border-radius: 20px;
            background: #fff;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.25s;
        }

        .portrait-card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
            border-color: var(--border);
            transform: translateY(-4px);
        }

        .card-preview {
            width: 100%;
            aspect-ratio: 0.75;
            background: #f4f4f6;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-preview i {
            font-size: 36px;
            color: var(--text-main);
        }

        .portrait-card span {
            font-size: 13px;
            font-weight: 500;
            text-align: center;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê WORKSPACE & CANVAS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .workspace {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-workspace);
            cursor: var(--cursor-arrow);
        }

        .canvas {
            position: relative;
            width: 100%;
            height: 100%;
            background: #fdfdfd;
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .content-layer {
            position: absolute;
            inset: 0;
            z-index: 8;
            transform-origin: 0 0;
        }

        .fixed-backdrop {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .fixed-backdrop img {
            width: 170%;
            height: 170%;
            max-width: none;
            object-fit: contain;
            object-position: center center;
            transform: none;
            filter: drop-shadow(0 20px 60px rgba(0, 0, 0, 0.12));
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê CANVAS ELEMENTS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .canvas-element {
            position: absolute;
            z-index: 10;
            user-select: none;
            cursor: var(--cursor-drag);
        }

        .canvas-element:active {
            cursor: var(--cursor-drag), grabbing;
        }

        .canvas-element.selected {
            outline: none;
            border-radius: 4px;
        }

        .el-content {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 8px;
            border: none;
            pointer-events: none;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê IMAGE FRAMES √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        /* Frame 1: Polaroid with Pin */
        .frame-polaroid-pin {
            background: #fff;
            padding: 10px 10px 40px 10px;
            border-radius: 3px;
            box-shadow: 2px 4px 16px rgba(0, 0, 0, 0.18), 0 1px 4px rgba(0, 0, 0, 0.1);
            transform: rotate(-2deg);
        }

        .frame-polaroid-pin .el-content {
            border-radius: 0;
        }

        .frame-polaroid-pin::after {
            content: '\1F4CC';
            position: absolute;
            top: -12px;
            right: 20px;
            font-size: 24px;
            z-index: 30;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
            transform: rotate(15deg);
        }

        /* Frame 2: Red Gallery Frame */
        .frame-red-gallery {
            background: #fff;
            padding: 20px;
            border: 5px solid #c41230;
            border-radius: 2px;
            box-shadow: 4px 6px 20px rgba(0, 0, 0, 0.22), inset 0 0 0 1px rgba(196, 18, 48, 0.3);
        }

        .frame-red-gallery .el-content {
            border-radius: 0;
        }

        /* Frame 3: Classic Polaroid */
        .frame-classic-polaroid {
            background: #fff;
            padding: 12px 12px 48px 12px;
            border-radius: 2px;
            box-shadow: 3px 5px 18px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .frame-classic-polaroid .el-content {
            border-radius: 0;
        }

        /* Letter control buttons */
        .letter-ctrl-btn {
            padding: 6px 14px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #fff;
            transition: all 0.15s;
            backdrop-filter: blur(4px);
        }

        .letter-ctrl-btn:hover {
            background: rgba(255, 255, 255, 0.45);
        }

        .letter-ctrl-btn.active {
            background: #fff;
            color: #1a1a1c;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        /* Music iframe embeds should remain interactive */
        .el-music iframe.el-content {
            pointer-events: auto;
        }

        .music-drag-handle {
            position: absolute;
            top: -14px;
            left: -14px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.96);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.16);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 35;
            cursor: move;
            color: #1a1a1c;
            font-size: 14px;
            line-height: 1;
            user-select: none;
            pointer-events: auto;
        }

        .canvas-element.el-music:hover .music-drag-handle,
        .canvas-element.el-music.selected .music-drag-handle {
            display: flex;
        }

        .resize-handle {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: se-resize;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }

        .canvas-element.selected .resize-handle {
            display: flex;
        }

        .resize-handle.se {
            bottom: -16px;
            right: -16px;
        }

        /* Rotate handle - shown on hover outside element */
        .rotate-handle {
            position: absolute;
            bottom: -44px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            border: 1.5px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 25;
        }

        .rotate-handle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 10px;
            background: var(--border);
        }

        .canvas-element:hover .rotate-handle,
        .canvas-element.edge-hover .rotate-handle,
        .canvas-element.selected .rotate-handle {
            opacity: 1;
        }

        .rotate-handle svg {
            width: 14px;
            height: 14px;
            color: #666;
        }

        .control-icon {
            width: 14px;
            height: 14px;
            color: var(--text-main);
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê CONTEXT BAR √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .context-bar {
            position: absolute;
            top: -65px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 8px;
            display: flex;
            gap: 6px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.15);
            z-index: 100;
            pointer-events: auto;
        }

        .bar-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .bar-btn:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .bar-btn i {
            font-size: 22px;
        }

        .bar-btn-delete:hover {
            background: #ffe4e6;
            color: #e11d48;
        }

        .media-close-btn {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.96);
            color: #222;
            font-size: 18px;
            line-height: 1;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 30;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.16);
        }

        .canvas-element:hover .media-close-btn,
        .canvas-element.selected .media-close-btn {
            display: flex;
        }

        /* Specialized Elements Styles */
        .el-letter {
            cursor: var(--cursor-drag);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .envelope-view {
            width: 100%;
            height: 100%;
            background: url('envelope.png') center/cover;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .paper-view {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffe0e9 0%, #fff5f7 100%);
            padding: 40px 24px;
            border-radius: 12px;
            display: none;
            position: relative;
            border: 1px solid rgba(255, 182, 193, 0.3);
        }

        .el-letter.is-open .envelope-view {
            display: none;
        }

        .el-letter.is-open .paper-view {
            display: block;
        }

        .paper-view .el-content {
            font-family: 'Kalam', cursive;
            font-size: 18px;
            color: #4b2c34;
        }

        .love-sticker {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 26px;
            rotate: 12deg;
        }

        .best-woman-badge {
            position: absolute;
            bottom: 18px;
            left: 18px;
            background: #ff4d6d;
            color: #fff;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            rotate: -4deg;
        }

        .el-handwriting {
            font-family: 'Caveat', cursive;
            font-size: 36px;
            padding: 12px;
        }

        .el-sticker {
            font-size: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .frame-rounded {
            border-radius: 24px;
            overflow: visible;
        }

        .frame-rounded .el-content {
            border-radius: 24px;
        }

        .frame-circle {
            border-radius: 50%;
            overflow: visible;
        }

        .frame-circle .el-content {
            border-radius: 50%;
        }

        .frame-polaroid {
            padding: 4% 4% 14% 4% !important;
            background: #fff !important;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1) !important;
            border-radius: 2px !important;
        }

        .frame-shadow {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3) !important;
        }

        .frame-stroke {
            padding: 0;
            border: none;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
        }

        .frame-stroke .el-content {
            border-radius: 8px;
        }


        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê LETTER VIEWER OVERLAY √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        .letter-viewer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .letter-viewer-overlay.active {
            display: flex;
        }

        .letter-viewer-bg {
            width: auto;
            max-width: 480px;
            height: 92vh;
            border-radius: 24px;
            padding: 48px 36px;
            position: relative;
            display: flex;
            flex-direction: column;
            cursor: default;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            animation: letterSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes letterSlideUp {
            from {
                transform: translateY(40px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .letter-viewer-bg .texture {
            position: absolute;
            inset: 0;
            opacity: 0.04;
            pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            border-radius: 24px;
        }

        .letter-viewer-text {
            font-family: 'Kalam', cursive;
            font-size: 20px;
            line-height: 1.7;
            color: #4b2c34;
            white-space: pre-wrap;
            z-index: 2;
            flex: 1;
        }

        .letter-viewer-love {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: rotate(15deg);
            z-index: 5;
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            color: #ff4d6d;
            font-style: italic;
            border: 2px dashed #f8bbd0;
        }

        .letter-viewer-badges {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .letter-viewer-close {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .letter-viewer-close:hover {
            background: #fff;
        }

        .media-viewer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .media-viewer-overlay.active {
            display: flex;
        }

        .media-viewer-card {
            width: min(96vw, 980px);
            max-height: 90vh;
            background: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
            padding: 0;
            position: relative;
            overflow: visible;
        }

        .media-viewer-body {
            width: 100%;
            max-height: calc(90vh - 40px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-viewer-body img,
        .media-viewer-body video,
        .media-viewer-body iframe,
        .media-viewer-body audio {
            width: 100%;
            max-height: calc(90vh - 56px);
            border: none;
            border-radius: 0;
            background: transparent;
            object-fit: contain;
        }

        .letter-color-dots {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
            z-index: 10;
            width: max-content;
            pointer-events: none;
        }

        .letter-color-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: auto;
        }

        .letter-color-dot:hover {
            transform: scale(1.15);
        }

        .letter-paper-card .letter-actions {
            position: relative;
            z-index: 20;
        }

        /* Upload drop zone for video/music modals */
        .upload-dropzone {
            border: 2px dashed #ddd;
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .upload-dropzone:hover {
            border-color: #c9184a;
            background: #fff0f3;
        }

        .upload-dropzone.dragover {
            border-color: #c9184a;
            background: #fff0f3;
        }

        .or-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
            color: #86868b;
            font-size: 13px;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e5e5;
        }

        .modal {
            background: #fff;
            width: 440px;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-m {
            padding: 10px 20px;
            border-radius: 980px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-m-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        .btn-m-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .btn-m-primary {
            background: var(--text-main);
            color: #fff;
        }

        .btn-m-primary:hover {
            background: #000;
            transform: translateY(-1px);
        }

        .status-toast {
            position: fixed;
            top: 84px;
            right: 24px;
            z-index: 6000;
            background: rgba(0, 0, 0, 0.88);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            pointer-events: none;
        }

        .status-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>

</head>

<body>

    <div class="floating-add-btn" id="addToggleBtn" role="button" tabindex="0" aria-label="Open add menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24">
            <defs>
                <linearGradient id="editorHeartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff4d6d;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#c9184a;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path fill="url(#editorHeartGradient)"
                d="M16.5 13.287c-2.475-2.716-5.5-.712-5.5 2.112c0 2.56 1.814 4.035 3.358 5.292l.044.036l.427.35c.571.475 1.121.923 1.671.923s1.1-.448 1.671-.923C19.789 19.73 22 18.224 22 15.399c0-.927-.326-1.767-.853-2.38c-1.075-1.251-2.985-1.556-4.647.268" />
            <path fill="url(#editorHeartGradient)"
                d="M8.106 18.247C5.298 16.083 2 13.542 2 9.137C2 4.274 7.5.825 12 5.501C16.5.825 22 4.274 22 9.137c0 .834-.118 1.6-.329 2.31a4.2 4.2 0 0 0-2.619-.947c-.89-.005-1.758.274-2.553.81c-1.39-.933-2.956-1.058-4.33-.395c-1.635.79-2.669 2.556-2.669 4.484c0 2.306 1.149 3.923 2.342 5.095c-.948-.076-1.897-.808-2.88-1.583q-.417-.328-.856-.664" />
        </svg>
    </div>

    <div class="floating-nav-tools" aria-hidden="true" style="display:none"></div>

    <div class="floating-nav-tools right">
        <button class="nav-btn" id="undoBtn" title="Undo" onclick="undoAction()"><svg xmlns="http://www.w3.org/2000/svg"
                width="18" height="18" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                    <path d="M12 21A9 9 0 1 0 4.204 7.5" />
                    <path d="M3 3v1.278c0 2.192 0 3.288.707 3.887c.708.6 1.789.42 3.95.059L9 8" />
                </g>
            </svg></button>
        <button class="nav-btn" id="redoBtn" title="Redo" onclick="redoAction()"><svg xmlns="http://www.w3.org/2000/svg"
                width="18" height="18" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                    <path d="M12 21a9 9 0 1 1 7.796-13.5" />
                    <path d="M21 3v1.278c0 2.192 0 3.288-.708 3.887c-.707.6-1.788.42-3.95.059L14.999 8" />
                </g>
            </svg></button>
        <div style="width:1px; height:20px; background:rgba(0,0,0,0.1); margin:0 4px"></div>
        <button class="save-btn" id="saveShareBtn" type="button">Save &amp; Share</button>
    </div>

    <div class="floating-styles-btn" id="stylesToggleBtn" role="button" tabindex="0" aria-label="Open styles menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M6 4.5c0-.935 0-1.402.201-1.75a1.5 1.5 0 0 1 .549-.549C7.098 2 7.565 2 8.5 2h7c.935 0 1.402 0 1.75.201a1.5 1.5 0 0 1 .549.549C18 3.098 18 3.565 18 4.5s0 1.402-.201 1.75a1.5 1.5 0 0 1-.549.549C16.902 7 16.435 7 15.5 7h-7c-.935 0-1.402 0-1.75-.201a1.5 1.5 0 0 1-.549-.549C6 5.902 6 5.435 6 4.5m-.998-.56a.748.748 0 0 0 0 1.121Q5 4.813 5 4.541V4.46q0-.273.002-.52M10 16v4c0 .943 0 1.414.293 1.707S11.057 22 12 22s1.414 0 1.707-.293S14 20.943 14 20v-4c0-.943 0-1.414-.293-1.707S12.943 14 12 14s-1.414 0-1.707.293S10 15.057 10 16" />
            <path fill="currentColor"
                d="M18.994 5.25h.051c.455 0 .76 0 .997.016c.23.015.342.042.416.07c.323.128.578.383.706.706c.029.074.056.187.07.417c.016.236.016.541.016.996c0 .837-.01 1.067-.071 1.239a1.25 1.25 0 0 1-.592.687c-.161.086-.387.13-1.215.255l-4.123.618c-.773.116-1.421.213-1.934.358c-.543.152-1.023.38-1.398.816c-.384.445-.542.977-.61 1.578c.204-.006.42-.006.639-.006h.109c.265 0 .525 0 .766.011c.05-.32.127-.482.232-.604c.11-.127.278-.242.668-.351c.411-.116.966-.2 1.797-.325l4.196-.63c.65-.097 1.158-.172 1.577-.395a2.75 2.75 0 0 0 1.302-1.513c.158-.447.158-.96.157-1.617V7.43c0-.424 0-.779-.019-1.07a2.8 2.8 0 0 0-.172-.868a2.75 2.75 0 0 0-1.551-1.552a2.8 2.8 0 0 0-.869-.172a18 18 0 0 0-1.07-.019h-.075q.008.33.006.71v.08q.002.38-.006.71" />
        </svg>
    </div>

    <div class="styles-menu" id="stylesMenu">
        <div class="style-section">
            <span class="style-label">Bouquet</span>
            <button class="nav-btn"
                style="width:100%; height:40px; background:rgba(0,0,0,0.03); border-radius:12px; gap:8px"
                onclick="changeBouquet()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 40 40">
                    <g fill="none" stroke-miterlimit="10">
                        <path fill="#ff52a1" stroke="#231f20"
                            d="M37.8 3.88C36.25.88 26 .5 20 .5S3.75.88 2.2 3.88C.65 5.38.5 13.38.5 20s.15 14.62 1.7 16.12c1.55 3 11.8 3.38 17.8 3.38s16.25-.38 17.8-3.38c1.55-1.5 1.7-9.5 1.7-16.12s-.15-14.62-1.7-16.12Z" />
                        <path fill="#fff" stroke="#231f20"
                            d="M34 8.13c-1.23-1.82-9.3-2.06-14-2.06S7.23 6.31 6 8.13c-1.2.87-1.32 5.76-1.32 9.78S4.8 26.79 6 27.7c1.21 1.82 9.28 2.05 14 2.05s12.77-.23 14-2.05c1.22-.91 1.34-5.77 1.34-9.79S35.2 9 34 8.13Z" />
                        <path fill="#ffe236" stroke="#231f20"
                            d="M27.53 16a20.8 20.8 0 0 0-3.22-4.2a2.22 2.22 0 0 0-2.89 0a21.3 21.3 0 0 0-3.21 4.2c-.07.11-.2.34-.35.61a10 10 0 0 0-1.41-1.66a1.66 1.66 0 0 0-2.15 0a15.5 15.5 0 0 0-2.4 3.14c-.25.42-1.65 2.84-1.65 4.08a1.55 1.55 0 0 0 1.12 1.56c1.44.62 15 .67 16.87-.15a2.08 2.08 0 0 0 1.5-2.07c0-.11.26-1.39-2.21-5.51Z" />
                    </g>
                </svg> Change Bouquet
            </button>
        </div>
        <div class="style-section">
            <span class="style-label">Background</span>
            <div class="color-grid">
                <div class="color-dot active" style="background: #fff;" onclick="setCanvasBg('#fff', this)"></div>
                <div class="color-dot" style="background: #fdf2f8;" onclick="setCanvasBg('#fdf2f8', this)"></div>
                <div class="color-dot" style="background: #eff6ff;" onclick="setCanvasBg('#eff6ff', this)"></div>
                <div class="color-dot" style="background: #f5f3ff;" onclick="setCanvasBg('#f5f3ff', this)"></div>
                <div class="color-dot" style="background: #f0fdf4;" onclick="setCanvasBg('#f0fdf4', this)"></div>
                <div class="color-dot" style="background: #fafafa;" onclick="setCanvasBg('#fafafa', this)"></div>
            </div>
        </div>
    </div>

    <div class="workspace" id="workspace">
        <div class="canvas" id="canvas">
            <div class="fixed-backdrop" id="fixedBouquet">
                <img src="./bf4c5981-fca3-4522-8d53-5e9128cd3b72 1.png" alt="Main Bouquet">
            </div>
            <div class="content-layer" id="contentLayer"></div>
        </div>
    </div>

    <div class="add-menu" id="addMenu">
        <div class="menu-grid">
            <div class="portrait-card" onclick="addImage()">
                <div class="card-preview"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="0 0 40 40">
                        <g fill="none" stroke-miterlimit="10">
                            <path fill="#ff52a1" stroke="#231f20"
                                d="M37.8 3.88C36.25.88 26 .5 20 .5S3.75.88 2.2 3.88C.65 5.38.5 13.38.5 20s.15 14.62 1.7 16.12c1.55 3 11.8 3.38 17.8 3.38s16.25-.38 17.8-3.38c1.55-1.5 1.7-9.5 1.7-16.12s-.15-14.62-1.7-16.12Z" />
                            <path fill="#fff" stroke="#231f20"
                                d="M34 8.13c-1.23-1.82-9.3-2.06-14-2.06S7.23 6.31 6 8.13c-1.2.87-1.32 5.76-1.32 9.78S4.8 26.79 6 27.7c1.21 1.82 9.28 2.05 14 2.05s12.77-.23 14-2.05c1.22-.91 1.34-5.77 1.34-9.79S35.2 9 34 8.13Z" />
                            <path fill="#ffe236" stroke="#231f20"
                                d="M27.53 16a20.8 20.8 0 0 0-3.22-4.2a2.22 2.22 0 0 0-2.89 0a21.3 21.3 0 0 0-3.21 4.2c-.07.11-.2.34-.35.61a10 10 0 0 0-1.41-1.66a1.66 1.66 0 0 0-2.15 0a15.5 15.5 0 0 0-2.4 3.14c-.25.42-1.65 2.84-1.65 4.08a1.55 1.55 0 0 0 1.12 1.56c1.44.62 15 .67 16.87-.15a2.08 2.08 0 0 0 1.5-2.07c0-.11.26-1.39-2.21-5.51Z" />
                        </g>
                    </svg></div>
                <span>Image</span>
            </div>
            <div class="portrait-card" onclick="openModal('video')">
                <div class="card-preview"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="-0.5 0 41 41">
                        <g fill="none" stroke-miterlimit="10">
                            <path fill="#48eeff" stroke="#231f20"
                                d="M22.18 4.49c-1.11-1.49-7.18-1-10.7-.57S1.94 5.31 1.23 7.06C.42 8 .87 12.37 1.31 16s1.08 8 2.09 8.69c1.11 1.52 7.18 1 10.7.56s9.54-1.39 10.25-3.14c.81-.93.36-5.31-.08-8.93S23.2 5.2 22.18 4.49Z" />
                            <path fill="#fff" stroke="#231f20"
                                d="M20.07 12c-.75-.76-5.07-.22-7.58.09s-6.83.82-7.38 1.74c-.6.5-.39 2.74-.17 4.6s.57 4.08 1.27 4.42c.76.75 5.07.21 7.59-.1S20.63 22 21.18 21c.6-.5.39-2.74.16-4.6s-.57-4.03-1.27-4.4Z" />
                            <path fill="#ffe236" stroke="#231f20"
                                d="M29.202 13.83c.321.05.645.067.952.052a3.3 3.3 0 0 0 .836-.142c.246-.079.447-.186.593-.315a.74.74 0 0 0 .26-.44a.74.74 0 0 0-.114-.498c-.1-.168-.26-.331-.47-.48a3.3 3.3 0 0 0-.753-.39a4.7 4.7 0 0 0-.924-.238a4.7 4.7 0 0 0-.952-.053a3.3 3.3 0 0 0-.836.142a1.65 1.65 0 0 0-.593.315a.74.74 0 0 0-.26.44c-.025.161.014.33.114.498s.26.331.47.48c.21.15.466.282.753.39c.288.107.602.188.924.238Z" />
                            <path fill="#ff52a1" stroke="#231f20"
                                d="M34.3 22.34a15.4 15.4 0 0 0-2.94 2.1a14 14 0 0 0-1.25-1.7c-3.85-4.52-8.94-5.4-14-1.12s-5 9.45-1.12 14S24 41 29 36.71c6-5.07 9.57-8.08 10-8.92c.81-1.1-.4-2.78-1.18-3.7s-2.3-2.38-3.52-1.75Z" />
                            <path fill="#fff" stroke="#231f20"
                                d="M20.09 29.17a2.48 2.48 0 1 0 4.96 0a2.48 2.48 0 0 0-4.96 0Zm-4.94-.5a1.24 1.24 0 1 0 2.48 0a1.24 1.24 0 0 0-2.48 0Zm12.35.99a1.24 1.24 0 1 0 2.48 0a1.24 1.24 0 0 0-2.48 0Zm-6.67 5.68a1.24 1.24 0 1 0 2.48 0a1.24 1.24 0 0 0-2.48 0Zm.99-12.35a1.24 1.24 0 1 0 2.48 0a1.24 1.24 0 0 0-2.48 0Z" />
                        </g>
                    </svg></div>
                <span>Video</span>
            </div>
            <div class="portrait-card" onclick="openModal('letter')">
                <div class="card-preview"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="0 -0.5 41 41">
                        <g fill="none" stroke-miterlimit="10">
                            <path fill="#ffe236" stroke="#231f20"
                                d="M36 33.59c3-1.36 3.53-8.34 3.53-13.59S38.94 7.77 36 6.41c-1.48-1.36-9.4-1.73-16-1.73S5.52 5.05 4 6.41C1.06 7.77.5 14.75.5 20S1.06 32.23 4 33.59c1.49 1.36 9.41 1.73 16 1.73s14.49-.32 16-1.73Z" />
                            <path stroke="#231f20" stroke-linecap="round"
                                d="M4.67 13c3.65 3.81 8.94 7.93 10.57 8.64a10.81 10.81 0 0 0 9.52 0c1.62-.64 6.91-4.79 10.56-8.64m-20.89 8.39l-6.96 6.97m18.1-6.97l6.97 6.97" />
                        </g>
                    </svg></div>
                <span>Letter</span>
            </div>
            <div class="portrait-card" onclick="openModal('music')">
                <div class="card-preview"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="0 0 40 40">
                        <g fill="none">
                            <path fill="#ff52a1" stroke="#231f20" stroke-miterlimit="10"
                                d="M31.86 2a7.34 7.34 0 0 0-4.52 1.85l2.41 3.76L28 10.69l2.5 2.77l-2.87 4l-.23-3.27L24 11.8l1.52-3.88l-1.39-3.47a7.2 7.2 0 0 0-4.88-.15c-4.5 1.24-6 4.56-4.89 8.61C16.08 19.14 23 21.86 28.1 23a3.15 3.15 0 0 0 2-.37c4.4-2.85 9.9-7.83 9.36-14.26c-.37-4.19-2.95-6.77-7.6-6.37Z" />
                            <path fill="#48eeff" stroke="#231f20" stroke-miterlimit="10"
                                d="M27.65 22.1c0-.94-.5-1.59-1.89-2a38.4 38.4 0 0 0-7-.64c-2.91-.08-6.7 0-7.55.54a4.16 4.16 0 0 0-1.45 2.3c-.43 1.42-1 3.36-1.45 5c-3.08-.59-5.11.95-5.84 3.81s.38 5.44 3.73 6.3s5.52-.72 6.3-3.72l1.28-5c.1-.36.19-.74.29-1.13c1.19.12 2.57.2 3.82.24a5 5 0 0 0-2.87 3.64c-.77 3 .39 5.44 3.73 6.3s5.4-.75 6.3-3.73c.75-2.24 2.51-7.78 2.6-11.91Z" />
                            <path fill="#ffe236" stroke="#231f20" stroke-miterlimit="10"
                                d="M7.69 5.2c-.95.3-2.35.8-.69 4.6s2.65 3.57 3.12 3.43s1.42-.44.65-4.6S8.63 4.91 7.69 5.2Zm1.89 10.75a1.48 1.48 0 1 0 2.96 0a1.48 1.48 0 0 0-2.96 0Z" />
                        </g>
                    </svg></div>
                <span>Music</span>
            </div>
            <div class="portrait-card" onclick="addSticker('√¢¬ù¬§√Ø¬∏¬è')">
                <div class="card-preview"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="0 0 40 40">
                        <g fill="none" stroke-miterlimit="10">
                            <path fill="#ff52a1" stroke="#231f20"
                                d="M27.8 2.7A12.16 12.16 0 0 0 20 5.11a12.16 12.16 0 0 0-7.8-2.41C4.4 2.7.5 7.38.5 14.4c0 10.79 10 18.27 17.62 22.42a3.92 3.92 0 0 0 3.76 0C29.55 32.67 39.5 25.19 39.5 14.4c0-7.02-3.9-11.7-11.7-11.7Z" />
                            <path stroke="#fff" stroke-linecap="round" d="M28.36 6.71c4.38-.46 5.91 2 6.54 3.76" />
                        </g>
                    </svg></div>
                <span>Sticker</span>
            </div>
        </div>
    </div>

    <div class="context-bar" id="contextBar" style="display: none;">
        <button class="bar-btn" id="btnFrame" onclick="cycleFrame()" title="Frame Style">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 40 40">
                <g fill="none" stroke-miterlimit="10">
                    <path fill="#ff52a1" stroke="#231f20"
                        d="M37.8 3.88C36.25.88 26 .5 20 .5S3.75.88 2.2 3.88C.65 5.38.5 13.38.5 20s.15 14.62 1.7 16.12c1.55 3 11.8 3.38 17.8 3.38s16.25-.38 17.8-3.38c1.55-1.5 1.7-9.5 1.7-16.12s-.15-14.62-1.7-16.12Z" />
                    <path fill="#fff" stroke="#231f20"
                        d="M34 8.13c-1.23-1.82-9.3-2.06-14-2.06S7.23 6.31 6 8.13c-1.2.87-1.32 5.76-1.32 9.78S4.8 26.79 6 27.7c1.21 1.82 9.28 2.05 14 2.05s12.77-.23 14-2.05c1.22-.91 1.34-5.77 1.34-9.79S35.2 9 34 8.13Z" />
                    <path fill="#ffe236" stroke="#231f20"
                        d="M27.53 16a20.8 20.8 0 0 0-3.22-4.2a2.22 2.22 0 0 0-2.89 0a21.3 21.3 0 0 0-3.21 4.2c-.07.11-.2.34-.35.61a10 10 0 0 0-1.41-1.66a1.66 1.66 0 0 0-2.15 0a15.5 15.5 0 0 0-2.4 3.14c-.25.42-1.65 2.84-1.65 4.08a1.55 1.55 0 0 0 1.12 1.56c1.44.62 15 .67 16.87-.15a2.08 2.08 0 0 0 1.5-2.07c0-.11.26-1.39-2.21-5.51Z" />
                </g>
            </svg>
        </button>
        <button class="bar-btn" id="btnEdit" onclick="editSelectedLetter()" title="Edit Letter" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="1.8" d="m4 20l4.2-1l10-10a2.1 2.1 0 0 0-3-3l-10 10zM13.5 7.5l3 3" />
            </svg>
        </button>
        <div style="width:1px; height:20px; background:var(--border); margin:0 4px"></div>
        <button class="bar-btn bar-btn-delete" onclick="deleteSelected()" title="Delete">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
                    d="m19.5 5.5l-.62 10.025c-.158 2.561-.237 3.842-.88 4.763a4 4 0 0 1-1.2 1.128c-.957.584-2.24.584-4.806.584c-2.57 0-3.855 0-4.814-.585a4 4 0 0 1-1.2-1.13c-.642-.922-.72-2.205-.874-4.77L4.5 5.5M3 5.5h18m-4.944 0l-.683-1.408c-.453-.936-.68-1.403-1.071-1.695a2 2 0 0 0-.275-.172C13.594 2 13.074 2 12.035 2c-1.066 0-1.599 0-2.04.234a2 2 0 0 0-.278.18c-.395.303-.616.788-1.058 1.757L8.053 5.5m1.447 11v-6m5 6v-6" />
            </svg>
        </button>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div id="modalContent">
            <!-- Content will be injected by openModal() -->
        </div>
    </div>

    <!-- Letter Viewer Overlay -->
    <div class="letter-viewer-overlay" id="letterViewer" onclick="if(event.target===this)closeLetterViewer()"></div>
    <div class="media-viewer-overlay" id="mediaViewer" onclick="if(event.target===this)closeMediaViewer()"></div>

    <style>
        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê GLOBAL UTILITIES (Post-Style) √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        /* Status Toast */
        .status-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translate(-50%, 20px);
            background: rgba(26, 26, 28, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 980px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            backdrop-filter: blur(8px);
        }

        .status-toast.active {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* Publish modal controls */
        .pub-label {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .pub-input {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            background: #fafafa;
            outline: none;
        }

        .pub-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 2px 0 18px;
        }

        .pub-toggle-switch {
            appearance: none;
            width: 44px;
            height: 24px;
            border-radius: 999px;
            background: #d2d2d7;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .pub-toggle-switch::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.2s ease;
        }

        .pub-toggle-switch:checked {
            background: var(--primary);
        }

        .pub-toggle-switch:checked::after {
            transform: translateX(20px);
        }

        .pub-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .pub-tab {
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 999px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            color: #333;
            transition: all 0.2s ease;
        }

        .pub-tab.active {
            background: #1a1a1c;
            color: #fff;
            border-color: #1a1a1c;
        }

        .pub-answer-wrap {
            position: relative;
        }

        .pub-calendar-panel {
            margin-top: 10px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
        }

        .pub-calendar {
            background: rgba(255, 77, 109, 0.06);
            border: 1px solid rgba(255, 77, 109, 0.12);
            border-radius: 14px;
            padding: 10px;
        }

        .pub-calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .pub-calendar-header h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: #222;
        }

        .pub-calendar-nav {
            display: flex;
            gap: 6px;
        }

        .pub-calendar-nav button {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(255, 77, 109, 0.2);
            background: rgba(255, 77, 109, 0.08);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .pub-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }

        .pub-calendar-days span {
            text-align: center;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            padding: 3px 0;
        }

        .pub-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .pub-calendar-day {
            border: none;
            border-radius: 8px;
            height: 28px;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            color: #222;
        }

        .pub-calendar-day:hover {
            background: rgba(255, 77, 109, 0.14);
        }

        .pub-calendar-day.other {
            color: #bbb;
        }

        .pub-calendar-day.selected {
            background: linear-gradient(135deg, #ff4d6d, #c9184a);
            color: #fff;
        }

        /* √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê MOBILE RESPONSIVENESS √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê */
        @media (max-width: 768px) {
            .fixed-backdrop {
                top: 0;
                left: 0;
                transform: none;
                align-items: flex-start;
            }

            .fixed-backdrop img {
                width: auto;
                height: 140%;
                object-fit: cover;
                object-position: center top;
                transform: translate(-8%, -10%);
            }

            html,
            body {
                overscroll-behavior: none;
                touch-action: none;
            }

            .floating-add-btn {
                top: auto;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%);
                width: 64px;
                height: 64px;
                z-index: 4000;
            }

            .floating-nav-tools {
                top: 16px;
                width: 90%;
                max-width: 320px;
                height: 48px;
            }

            .floating-nav-tools.right {
                display: none;
            }

            .floating-styles-btn {
                bottom: 24px;
                right: 24px;
                width: 44px;
                height: 44px;
                z-index: 3999;
            }

            .add-menu {
                width: 90%;
                left: 5%;
                top: auto;
                bottom: 100px;
                grid-template-columns: repeat(3, 1fr);
                padding: 16px;
                z-index: 5001;
            }

            .styles-menu {
                width: 90%;
                right: 5%;
                bottom: 80px;
                z-index: 4000;
            }

            .letter-editor-fullscreen {
                width: 95%;
                min-width: unset;
                height: 85vh;
                padding: 24px 16px;
            }

            .letter-modal-card {
                width: 100%;
                padding: 24px 16px;
            }

            .letter-textarea {
                font-size: 16px;
            }

            #publishModalContent {
                width: 95%;
                padding: 24px;
            }

            .pub-tabs {
                gap: 6px;
            }

            .pub-tab {
                font-size: 11px;
                padding: 7px 10px;
            }

            #workspace,
            #canvas {
                touch-action: none;
                overscroll-behavior: none;
                height: 100dvh;
                max-height: 100dvh;
            }
        }
    </style>



    <!-- Big Footer Text -->
    <!-- Big Footer Text -->
    <!-- Publish Modal -->
    <div class="modal-overlay" id="publishModal"
        style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:5000; backdrop-filter:blur(4px);">
        <div id="publishModalContent"
            style="background: white; padding: 32px; border-radius: 24px; width: 420px; max-width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.2);">
            <button onclick="closePublishModal()"
                style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; line-height:1;">&times;</button>
            <h2 style="font-family: 'Playfair Display', serif; margin-bottom: 24px; color: #1a1a1c; font-size: 24px;">
                Publish Bouquet</h2>

            <!-- Form View -->
            <div id="publishFormView">
                <div style="margin-bottom: 16px;">
                    <label class="pub-label">Name</label>
                    <input type="text" id="pubName" class="pub-input" placeholder="e.g. ife-bouquet">
                    <div id="pubNameHint" style="font-size:12px; color:#666; margin-top:6px;">This will be used in your
                        link.</div>
                </div>

                <div class="pub-toggle-row">
                    <label class="pub-label" style="margin:0;">Password Protection</label>
                    <input type="checkbox" id="pubPasswordToggle" class="pub-toggle-switch" checked>
                </div>

                <div id="pubSecurityBlock">
                    <div style="margin-bottom: 16px;">
                        <label class="pub-label">Password Type</label>
                        <div class="pub-tabs" id="pubTypeTabs">
                            <button type="button" class="pub-tab active" data-type="date_short">Date (DD/MM)</button>
                            <button type="button" class="pub-tab" data-type="pin">PIN</button>
                            <button type="button" class="pub-tab" data-type="text">Text</button>
                            <button type="button" class="pub-tab" data-type="sentence">Sentence</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;" class="security-field">
                        <label class="pub-label">Question</label>
                        <input type="text" id="pubQuestion" class="pub-input"
                            placeholder="e.g. When is our anniversary?">
                    </div>

                    <div style="margin-bottom: 22px;" class="security-field">
                        <label class="pub-label">Answer</label>
                        <div id="pubAnswerContainer"></div>
                    </div>
                </div>

                <button class="header-btn primary" onclick="confirmPublish()"
                    style="background:var(--primary); color:white; width: 100%; justify-content: center; height: 50px; font-weight: 500; font-size: 16px; border-radius:14px;">
                    Publish & Get Link
                </button>
            </div>

            <!-- Success View (Hidden by default) -->
            <div id="publishSuccessView"
                style="display:none; text-align:center; flex-direction:column; align-items:center;">
                <div style="font-size:48px; margin-bottom:16px;">‚ú®</div>
                <h3 style="font-family:'Playfair Display',serif; font-size:24px; margin-bottom:8px; color:#c9184a;">
                    Published Successfully!</h3>
                <p style="color:#666; margin-bottom:24px;">Your bouquet is ready to share.</p>

                <div
                    style="width:100%; background:#f5f5f5; border-radius:12px; padding:8px 8px 8px 16px; display:flex; align-items:center; margin-bottom:24px; border:1px solid #eee;">
                    <input type="text" id="finalPubLink" readonly
                        style="flex:1; border:none; background:transparent; font-size:14px; color:#444; overflow:hidden; text-overflow:ellipsis; outline:none;">
                    <button onclick="copyPubLink()"
                        style="background:white; border:1px solid #ddd; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:500; color:#333; margin-left:8px; transition:all 0.2s;">Copy</button>
                </div>

                <div style="display:flex; gap:12px; width:100%;">
                    <button onclick="window.open(document.getElementById('finalPubLink').value, '_blank')"
                        style="flex:1; background:var(--primary); color:white; border:none; padding:12px; border-radius:12px; font-weight:500; cursor:pointer;">Open
                        Bouquet</button>
                    <button onclick="closePublishModal()"
                        style="flex:1; background:white; border:1px solid #ddd; color:#333; padding:12px; border-radius:12px; font-weight:500; cursor:pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        /* 
           SUPABASE CONFIGURATION 
           (Restored)
        */
        const SUPABASE_URL = 'https://yahblufnafnyqoligtlw.supabase.co';
        const SUPABASE_KEY =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaGJsdWZuYWZueXFvbGlndGx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTQ0NjYsImV4cCI6MjA4NjU3MDQ2Nn0.ZV0aMjzTMHWThE-0x2LIoq2WxcubL67pBVNiyQPosV0';

        console.log('Initializing Supabase...');
        const supabaseClient = (window.supabase && window.supabase.createClient)
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null;

        if (supabaseClient) console.log('Supabase client initialized');
        else console.error('Supabase client FAILED to initialize (window.supabase missing?)');

        /* Publish Modal Logic */
        let currentPubType = 'date_short';
        let pubCalMonth = (new Date()).getMonth();
        let pubCalYear = (new Date()).getFullYear();
        const pubMonthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September',
            'October', 'November', 'December'];

        function slugifyName(value) {
            const base = String(value || '')
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            return base || 'bouquet';
        }

        function withTimeout(promise, ms, message) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error(message || 'Request timeout')), ms))
            ]);
        }

        async function fetchTakenPublishNames(candidates) {
            if (!supabaseClient || !Array.isArray(candidates) || candidates.length === 0) return new Set();
            try {
                const query = supabaseClient
                    .from('canvases')
                    .select('id')
                    .in('id', candidates);
                const { data, error } = await withTimeout(query, 5000, 'Name check timed out');
                if (error) return new Set();
                return new Set((Array.isArray(data) ? data : []).map((row) => row.id));
            } catch (err) {
                return new Set();
            }
        }

        async function resolveUniquePublishName(rawName) {
            const base = slugifyName(rawName);
            const firstPass = [base];
            for (let n = 10; n <= 100; n += 10) firstPass.push(`${base}${n}`);
            const firstTaken = await fetchTakenPublishNames(firstPass);
            for (const candidate of firstPass) {
                if (!firstTaken.has(candidate)) return candidate;
            }

            for (let start = 110; start <= 10000; start += 100) {
                const batch = [];
                for (let n = start; n < start + 100 && n <= 10000; n += 10) {
                    batch.push(`${base}${n}`);
                }
                const taken = await fetchTakenPublishNames(batch);
                for (const candidate of batch) {
                    if (!taken.has(candidate)) return candidate;
                }
            }
            throw new Error('Unable to generate available name.');
        }

        function setPubType(type) {
            currentPubType = type;
            document.querySelectorAll('#pubTypeTabs .pub-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            handlePubTypeChange();
        }

        function openPublishModal() {
            const m = document.getElementById('publishModal');
            m.style.display = 'flex';

            // Reset Views
            document.getElementById('publishFormView').style.display = 'block';
            document.getElementById('publishSuccessView').style.display = 'none';
            // Reset Button
            const btn = document.querySelector('#publishModalContent button.header-btn');
            if (btn) {
                btn.innerText = 'Publish & Get Link';
                btn.disabled = false;
            }

            const toggle = document.getElementById('pubPasswordToggle');
            if (toggle) toggle.checked = true;
            setPubType(currentPubType || 'date_short');
            updatePublishSecurityVisibility();
        }

        function closePublishModal() {
            document.getElementById('publishModal').style.display = 'none';
        }

        function updatePublishSecurityVisibility() {
            const toggle = document.getElementById('pubPasswordToggle');
            const block = document.getElementById('pubSecurityBlock');
            if (!toggle || !block) return;
            block.style.display = toggle.checked ? 'block' : 'none';
        }

        function renderPubDateCalendar() {
            const header = document.getElementById('pubCalHeader');
            const grid = document.getElementById('pubCalGrid');
            const answerInput = document.getElementById('pubAnswer');
            if (!header || !grid || !answerInput) return;

            header.textContent = `${pubMonthNames[pubCalMonth]} ${pubCalYear}`;
            grid.innerHTML = '';

            const firstDay = new Date(pubCalYear, pubCalMonth, 1).getDay();
            const daysInMonth = new Date(pubCalYear, pubCalMonth + 1, 0).getDate();
            const prevMonthDays = new Date(pubCalYear, pubCalMonth, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'pub-calendar-day other';
                btn.textContent = String(prevMonthDays - firstDay + i + 1);
                btn.disabled = true;
                grid.appendChild(btn);
            }

            const selected = String(answerInput.value || '').trim();
            for (let day = 1; day <= daysInMonth; day++) {
                const dd = String(day).padStart(2, '0');
                const mm = String(pubCalMonth + 1).padStart(2, '0');
                const val = `${dd}/${mm}`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'pub-calendar-day';
                if (selected === val) btn.classList.add('selected');
                btn.textContent = String(day);
                btn.onclick = () => {
                    answerInput.value = val;
                    renderPubDateCalendar();
                };
                grid.appendChild(btn);
            }

            const totalCells = firstDay + daysInMonth;
            const tail = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= tail; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'pub-calendar-day other';
                btn.textContent = String(i);
                btn.disabled = true;
                grid.appendChild(btn);
            }
        }

        function shiftPubMonth(delta) {
            pubCalMonth += delta;
            while (pubCalMonth < 0) {
                pubCalMonth += 12;
                pubCalYear -= 1;
            }
            while (pubCalMonth > 11) {
                pubCalMonth -= 12;
                pubCalYear += 1;
            }
            renderPubDateCalendar();
        }

        function handlePubTypeChange() {
            const type = currentPubType;
            const container = document.getElementById('pubAnswerContainer');
            if (!type || !container) return;

            if (type === 'date_short') {
                container.innerHTML = `
                    <div class="pub-answer-wrap">
                        <input type="text" id="pubAnswer" class="pub-input" placeholder="DD/MM" readonly>
                    </div>
                    <div class="pub-calendar-panel">
                        <div class="pub-calendar">
                            <div class="pub-calendar-header">
                                <h4 id="pubCalHeader"></h4>
                                <div class="pub-calendar-nav">
                                    <button type="button" onclick="shiftPubMonth(-1)">&#8249;</button>
                                    <button type="button" onclick="shiftPubMonth(1)">&#8250;</button>
                                </div>
                            </div>
                            <div class="pub-calendar-days">
                                <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                            </div>
                            <div id="pubCalGrid" class="pub-calendar-grid"></div>
                        </div>
                    </div>
                `;
                renderPubDateCalendar();
            } else if (type === 'pin') {
                container.innerHTML = '<input type="number" id="pubAnswer" class="pub-input" placeholder="Enter PIN code (e.g. 1234)">';
            } else if (type === 'sentence') {
                container.innerHTML = '<textarea id="pubAnswer" class="pub-input" placeholder="Enter the exact phrase..." style="height: 80px; resize: none;"></textarea>';
            } else {
                container.innerHTML = '<input type="text" id="pubAnswer" class="pub-input" placeholder="Enter answer...">';
            }
        }

        async function publishCanvasWithName(publishName, securityConfig) {
            if (!supabaseClient) throw new Error('Publishing is unavailable right now.');

            const state = collectCanvasState();
            const { elements, footerText, bgColor } = state;
            const resolvedName = await resolveUniquePublishName(publishName);
            const dataToSave = {
                elements,
                footerText,
                bgColor,
                name: resolvedName, // Save name INSIDE the JSON blob since there's no column for it
                ...(securityConfig ? { security: securityConfig } : {})
            };

            const writeQuery = supabaseClient
                .from('canvases')
                .upsert({
                    id: canvasId,
                    // name column doesn't exist, so we don't save it here
                    canvas_data: dataToSave,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'id' });
            const { error } = await withTimeout(writeQuery, 30000, 'Publish timed out');
            if (error) throw new Error(error.message || 'Publish failed.');
            return resolvedName;
        }

        async function confirmPublish() {
            const nameInput = document.getElementById('pubName');
            const questionInput = document.getElementById('pubQuestion');
            const answerInput = document.getElementById('pubAnswer');
            const passwordToggle = document.getElementById('pubPasswordToggle');
            const nameHint = document.getElementById('pubNameHint');

            const rawName = nameInput ? nameInput.value : '';
            const question = questionInput ? questionInput.value.trim() : '';
            const answer = answerInput ? answerInput.value.trim() : '';
            const passwordEnabled = !!(passwordToggle && passwordToggle.checked);
            const type = currentPubType;

            if (!rawName || !rawName.trim()) {
                alert('Please enter a name for the link.');
                return;
            }

            let securityConfig = { type: 'none', question: '', answer: '' };
            if (passwordEnabled) {
                if (!question || !answer) {
                    alert('Please fill in question and answer.');
                    return;
                }
                securityConfig = { type, question, answer };
            }

            try {
                const btn = document.querySelector('#publishModalContent button.header-btn');
                const originalText = btn.innerText;
                btn.innerText = 'Publishing...';
                btn.disabled = true;

                // detailed comment: Capture resolvedName so we can use it in success message/logic below
                const resolvedName = await publishCanvasWithName(rawName, securityConfig);

                // Use resolvedName for the link (vanity URL) because we are saving it to the 'name' column now
                const url = buildPreviewUrl(resolvedName);

                // --- SHOW SUCCESS VIEW ---
                document.getElementById('publishFormView').style.display = 'none';
                document.getElementById('publishSuccessView').style.display = 'flex';
                document.getElementById('finalPubLink').value = url;

                showStatusToast('Published Successfully!');
                // We do NOT close the modal automatically anymore
            } catch (err) {
                alert('PUBLISH ERROR: ' + ((err && err.message) ? err.message : JSON.stringify(err)));
                // Only re-enable button if error
                const btn = document.querySelector('#publishModalContent button.header-btn');
                if (btn) {
                    btn.innerText = 'Publish & Get Link';
                    btn.disabled = false;
                }
            }
        }

        async function copyPubLink() {
            const input = document.getElementById('finalPubLink');
            if (!input) return;
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices
            try {
                await navigator.clipboard.writeText(input.value);
                // Visual feedback on the button
                const btn = event.target; // Simple way to get button
                const oldText = btn.innerText;
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = oldText, 2000);
            } catch (err) {
                console.error('Copy failed', err);
                alert('Could not auto-copy. Please copy the link manually.');
            }
        }

        const canvas = document.getElementById('canvas');
        const contentLayer = document.getElementById('contentLayer');
        const workspace = document.getElementById('workspace');
        const contextBar = document.getElementById('contextBar');
        const addMenu = document.getElementById('addMenu');
        const stylesMenu = document.getElementById('stylesMenu');
        const addToggleBtn = document.getElementById('addToggleBtn');
        const stylesToggleBtn = document.getElementById('stylesToggleBtn');
        const saveShareBtn = document.getElementById('saveShareBtn');
        if (saveShareBtn) {
            saveShareBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right:8px"></i> Publish';
            saveShareBtn.onclick = openPublishModal;
        }
        const pubTypeTabs = document.getElementById('pubTypeTabs');
        if (pubTypeTabs) {
            pubTypeTabs.addEventListener('click', (event) => {
                const tab = event.target.closest('.pub-tab');
                if (!tab) return;
                setPubType(tab.dataset.type || 'date_short');
            });
        }
        const pubPasswordToggle = document.getElementById('pubPasswordToggle');
        if (pubPasswordToggle) {
            pubPasswordToggle.addEventListener('change', updatePublishSecurityVisibility);
        }
        setPubType(currentPubType);
        updatePublishSecurityVisibility();
        const fileInput = document.createElement('input');
        fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        const bouquetInput = document.createElement('input');
        bouquetInput.type = 'file'; bouquetInput.accept = 'image/*'; bouquetInput.style.display = 'none';
        document.body.appendChild(bouquetInput);

        let selectedEl = null;
        let isDragging = false;
        let isResizing = false;
        let dragMoved = false;
        let suppressOpenOnce = false;
        let startPos = { x: 0, y: 0 };
        let startElPos = { x: 0, y: 0, w: 0, h: 0 };
        let zIndexCounter = 10;
        let currentZoom = 1;
        let panX = 0;
        let panY = 0;
        let editingLetterEl = null;
        const mobileTouchLocks = [];
        let initialRestoreDone = false;
        const LAYOUT_DESKTOP = 'desktop';
        const LAYOUT_MOBILE = 'mobile';
        let lastCanvasState = null;
        let lastAppliedLayoutMode = null;

        function getLayoutMode() {
            return isMobileViewport() ? LAYOUT_MOBILE : LAYOUT_DESKTOP;
        }

        function generateElementId() {
            if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
            return `el-${Date.now()}-${Math.floor(Math.random() * 1000000)}`;
        }

        function ensureElementId(el) {
            if (!el.dataset.elementId) el.dataset.elementId = generateElementId();
            return el.dataset.elementId;
        }

        function cloneDeep(value) {
            return JSON.parse(JSON.stringify(value));
        }

        function normalizeLayout(layout, fallback = {}) {
            const src = layout || {};
            return {
                left: src.left ?? fallback.left ?? '0px',
                top: src.top ?? fallback.top ?? '0px',
                width: src.width ?? fallback.width ?? '',
                height: src.height ?? fallback.height ?? '',
                zIndex: src.zIndex ?? fallback.zIndex ?? '',
                rotation: src.rotation ?? fallback.rotation ?? '0',
                transform: src.transform ?? fallback.transform ?? ''
            };
        }

        function normalizeElementRecord(raw) {
            const legacyLayout = normalizeLayout({
                left: raw.left,
                top: raw.top,
                width: raw.width,
                height: raw.height,
                zIndex: raw.zIndex,
                rotation: raw.rotation,
                transform: raw.transform
            });
            const layouts = (raw.layouts && typeof raw.layouts === 'object') ? raw.layouts : {};
            const desktopLayout = normalizeLayout(layouts[LAYOUT_DESKTOP], legacyLayout);
            const mobileLayout = normalizeLayout(layouts[LAYOUT_MOBILE], desktopLayout);

            return {
                id: raw.id || raw.elementId || generateElementId(),
                type: raw.type || ((raw.classes || '').match(/el-(\w+)/) || [])[1] || 'image',
                letterText: raw.letterText || '',
                letterBg: raw.letterBg || '#ff69b4',
                letterFontSize: raw.letterFontSize || 'medium',
                letterTextAlign: raw.letterTextAlign || 'center',
                contentHTML: raw.contentHTML || '',
                classes: (raw.classes || '').replace(/\s+/g, ' ').trim(),
                layouts: {
                    [LAYOUT_DESKTOP]: desktopLayout,
                    [LAYOUT_MOBILE]: mobileLayout
                }
            };
        }

        function normalizeCanvasState(state) {
            const source = state && typeof state === 'object' ? state : {};
            const sourceElements = Array.isArray(source.elements) ? source.elements : (Array.isArray(state) ? state : []);
            return {
                elements: sourceElements.map(normalizeElementRecord),
                footerText: source.footerText || '',
                bgColor: source.bgColor || document.body.style.background || ''
            };
        }

        function getLayoutForMode(record, mode) {
            const normalized = normalizeElementRecord(record);
            if (!normalized.layouts) {
                console.warn('Missing layouts for element:', normalized);
                // Fallback to legacy structure if present or defaults
                return normalizeLayout(record);
            }
            return normalized.layouts[mode] || normalized.layouts['desktop'] || normalized.layouts['mobile'] || normalizeLayout(record);
        }

        function toLayoutSnapshotFromElement(el) {
            return normalizeLayout({
                left: el.style.left,
                top: el.style.top,
                width: el.style.width,
                height: el.style.height,
                zIndex: el.style.zIndex,
                rotation: el.dataset.rotation || '0',
                transform: el.style.transform
            });
        }

        let editorInitialized = false;
        function initializeEditor() {
            if (editorInitialized) return;
            editorInitialized = true;
            bindFloatingControls();
            updateUndoRedoButtons();
            restoreCanvas();
            window.addEventListener('resize', scheduleViewportFit);
            window.addEventListener('orientationchange', scheduleViewportFit);
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', scheduleViewportFit);
            }
            bindMobileTouchLock();
        }

        async function stabilizeAndRevealContentLayer() {
            fitCanvasToViewport(true);
            initialRestoreDone = true;
        }

        function bindMobileTouchLock() {
            if (!workspace || !canvas) return;
            if (!isMobileViewport()) return;
            if (mobileTouchLocks.length > 0) return;

            const preventTouchMove = (event) => event.preventDefault();
            workspace.addEventListener('touchmove', preventTouchMove, { passive: false });
            canvas.addEventListener('touchmove', preventTouchMove, { passive: false });
            if (contentLayer) contentLayer.addEventListener('touchmove', preventTouchMove, { passive: false });
            mobileTouchLocks.push(preventTouchMove);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEditor);
            window.addEventListener('load', initializeEditor);
        } else {
            initializeEditor();
        }

        function isMobileViewport() {
            return window.matchMedia('(max-width: 768px)').matches;
        }

        function updateZoomLabel() {
            const zoomLabel = document.getElementById('zoomLevel');
            if (zoomLabel) zoomLabel.textContent = `${Math.round(currentZoom * 100)}%`;
        }

        function applyCanvasTransform() {
            if (!contentLayer) return;
            contentLayer.style.transformOrigin = '0 0';
            contentLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            updateZoomLabel();
        }

        function resetCanvasViewport() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            if (contentLayer) {
                contentLayer.style.transformOrigin = '0 0';
                contentLayer.style.transform = 'none';
            }
            updateZoomLabel();
        }

        function getCanvasElementsBounds() {
            const host = contentLayer || canvas;
            const nodes = Array.from(host.querySelectorAll('.canvas-element'));
            const baseWidth = canvas.clientWidth || workspace.clientWidth || window.innerWidth;
            const baseHeight = canvas.clientHeight || workspace.clientHeight || window.innerHeight;
            if (nodes.length === 0 && (!baseWidth || !baseHeight)) return null;

            // Always include the canvas frame itself so mobile never collapses into a tiny cluster.
            let minX = 0;
            let minY = 0;
            let maxX = Math.max(1, baseWidth);
            let maxY = Math.max(1, baseHeight);

            nodes.forEach((el) => {
                const x = parseFloat(el.style.left) || 0;
                const y = parseFloat(el.style.top) || 0;
                const w = el.offsetWidth || parseFloat(el.style.width) || 0;
                const h = el.offsetHeight || parseFloat(el.style.height) || 0;
                // Include nearby off-canvas elements so fit can pull them back into view,
                // while still rejecting extreme corrupted coordinates.
                const minXLimit = -baseWidth;
                const maxXLimit = baseWidth * 2;
                const minYLimit = -baseHeight;
                const maxYLimit = baseHeight * 2;
                const x1 = Math.max(minXLimit, Math.min(maxXLimit, x));
                const y1 = Math.max(minYLimit, Math.min(maxYLimit, y));
                const x2 = Math.max(minXLimit, Math.min(maxXLimit, x + w));
                const y2 = Math.max(minYLimit, Math.min(maxYLimit, y + h));
                if (x2 > x1 && y2 > y1) {
                    minX = Math.min(minX, x1);
                    minY = Math.min(minY, y1);
                    maxX = Math.max(maxX, x2);
                    maxY = Math.max(maxY, y2);
                }
            });

            return {
                minX,
                minY,
                maxX,
                maxY,
                width: Math.max(1, maxX - minX),
                height: Math.max(1, maxY - minY)
            };
        }

        function fitCanvasToViewport(force = false) {
            if (!isMobileViewport()) {
                resetCanvasViewport();
                return;
            }

            const bounds = getCanvasElementsBounds();
            if (!bounds) {
                resetCanvasViewport();
                return;
            }

            const workspaceRect = workspace.getBoundingClientRect();
            const availableW = Math.max(1, workspaceRect.width);
            const availableH = Math.max(1, workspaceRect.height);
            const scaleX = availableW / Math.max(1, bounds.width);
            const scaleY = availableH / Math.max(1, bounds.height);
            currentZoom = Math.min(Math.max(Math.min(scaleX, scaleY, 1), 0.15), 1);
            panX = (availableW - bounds.width * currentZoom) / 2 - bounds.minX * currentZoom;
            panY = (availableH - bounds.height * currentZoom) / 2 - bounds.minY * currentZoom;

            // Clamp horizontal/vertical overflow so off-right/off-bottom content is pushed back in-frame.
            const projectedLeft = bounds.minX * currentZoom + panX;
            const projectedRight = bounds.maxX * currentZoom + panX;
            const projectedTop = bounds.minY * currentZoom + panY;
            const projectedBottom = bounds.maxY * currentZoom + panY;

            if (projectedRight > availableW) panX -= (projectedRight - availableW);
            if (projectedLeft < 0) panX -= projectedLeft;
            if (projectedBottom > availableH) panY -= (projectedBottom - availableH);
            if (projectedTop < 0) panY -= projectedTop;

            // User-requested bias: nudge content left to reveal right-side elements.
            const leftBias = Math.round(availableW * 0.18);
            panX -= leftBias;

            applyCanvasTransform();
        }

        let fitViewportTimeout = null;
        function scheduleViewportFit() {
            if (!initialRestoreDone) return;
            const mode = getLayoutMode();
            if (lastAppliedLayoutMode && mode !== lastAppliedLayoutMode && lastCanvasState) {
                applyCanvasState(lastCanvasState);
                return;
            }
            clearTimeout(fitViewportTimeout);
            fitViewportTimeout = setTimeout(() => fitCanvasToViewport(true), 100);
        }

        function zoomCanvas(factor) {
            // Manual zoom controls were removed; keep as no-op for backward compatibility.
            return;
        }

        function select(el) {
            if (selectedEl) selectedEl.classList.remove('selected');
            selectedEl = el;
            selectedEl.classList.add('selected');
            updateContextBar();
        }

        function createNewElement(type, x, y, w, h) {
            const el = document.createElement('div');
            el.className = `canvas-element el-${type}`;
            el.dataset.elementId = generateElementId();
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.width = w ? (w + 'px') : 'auto';
            el.style.height = h ? (h + 'px') : 'auto';
            el.style.zIndex = zIndexCounter++;
            el.dataset.rotation = 0;

            const handle = document.createElement('div');
            handle.className = 'resize-handle se';
            handle.innerHTML = `<svg class="control-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>`;
            handle.onmousedown = (e) => { e.stopPropagation(); startResize(e, el); };
            handle.ontouchstart = (e) => { e.stopPropagation(); startResize(e, el); };
            el.appendChild(handle);

            const rotHandle = document.createElement('div');
            rotHandle.className = 'rotate-handle';
            rotHandle.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /><polyline points="17 2 21 3.5 19.5 7.5" /></svg>`;
            rotHandle.onmousedown = (e) => { e.stopPropagation(); startRotate(e, el); };
            el.appendChild(rotHandle);

            el.onmousedown = (e) => {
                if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') || e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                startDrag(e, el);
            };
            el.ontouchstart = (e) => {
                if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') || e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                startDrag(e, el);
            };
            el.onmouseenter = () => { if (!isDragging && !isResizing) select(el); };
            el.onclick = (e) => {
                if (isDragging || isResizing) return;
                if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') || e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                if (suppressOpenOnce) { suppressOpenOnce = false; return; }
                if (type === 'image' || type === 'video') openMediaViewer(el);
                else if (type === 'music') { const audio = el.querySelector('audio'); if (audio) { if (audio.paused) audio.play(); else audio.pause(); } }
            };
            if (type === 'letter') { el.ondblclick = () => { if (isDragging || isResizing) return; editSelectedLetter(); }; }

            (contentLayer || canvas).appendChild(el);
            attachMusicDragHandle(el);
            select(el);
            saveCanvas();
            if (isMobileViewport()) scheduleViewportFit();
            return el;
        }


        function deselect() {
            if (selectedEl) selectedEl.classList.remove('selected');
            selectedEl = null;
            contextBar.style.display = 'none';
        }

        function attachRotateEdgeTracking(el) {
            const edgeThreshold = 16;
            el.addEventListener('mousemove', (event) => {
                const rect = el.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const nearEdge = x <= edgeThreshold || y <= edgeThreshold || x >= rect.width - edgeThreshold
                    || y >= rect.height - edgeThreshold;
                el.classList.toggle('edge-hover', nearEdge);
            });
            el.addEventListener('mouseleave', () => {
                el.classList.remove('edge-hover');
            });
        }

        function attachMediaCloseButton(el) {
            if (!el || (!el.classList.contains('el-video') && !el.classList.contains('el-music'))) return;
            if (el.querySelector('.media-close-btn')) return;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-close-btn';
            closeBtn.type = 'button';
            closeBtn.title = 'Close media';
            closeBtn.setAttribute('aria-label', 'Close media');
            closeBtn.textContent = '\u00D7';
            closeBtn.onmousedown = (e) => e.stopPropagation();
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                if (selectedEl === el) deselect();
                el.remove();
                saveCanvas();
            };
            el.appendChild(closeBtn);
        }

        function attachMusicDragHandle(el) {
            if (!el || !el.classList.contains('el-music')) return;
            if (el.querySelector('.music-drag-handle')) return;

            const dragHandle = document.createElement('button');
            dragHandle.className = 'music-drag-handle';
            dragHandle.type = 'button';
            dragHandle.title = 'Drag music';
            dragHandle.setAttribute('aria-label', 'Drag music');
            dragHandle.textContent = '√¢‚Ä†‚Ä¢';
            dragHandle.onmousedown = (e) => {
                e.stopPropagation();
                startDrag(e, el);
            };
            dragHandle.ontouchstart = (e) => {
                e.stopPropagation();
                startDrag(e, el);
            };
            el.appendChild(dragHandle);
        }

        workspace.onmousedown = (e) => {
            if (e.target === canvas || e.target === workspace || e.target === contentLayer) {
                deselect();
                addMenu.classList.remove('active');
                stylesMenu.classList.remove('active');
            }
        };

        function updateContextBar() {
            if (!selectedEl) {
                contextBar.style.display = 'none';
                return;
            }
            const isVideo = selectedEl.classList.contains('el-video');
            const isLetter = selectedEl.classList.contains('el-letter');
            if (isVideo) {
                contextBar.style.display = 'none';
                return;
            }
            contextBar.style.display = 'flex';
            selectedEl.appendChild(contextBar);
            const isFramable = selectedEl.classList.contains('el-image') || selectedEl.classList.contains('el-music');
            document.getElementById('btnFrame').style.display = isFramable ? 'flex' : 'none';
            const editBtn = document.getElementById('btnEdit');
            if (editBtn) editBtn.style.display = isLetter ? 'flex' : 'none';
        }

        function editSelectedLetter() {
            if (!selectedEl || !selectedEl.classList.contains('el-letter')) return;
            openModal('letter', {
                element: selectedEl,
                text: selectedEl.dataset.letterText || '',
                bg: selectedEl.dataset.letterBg || '#ff69b4',
                fontSize: selectedEl.dataset.letterFontSize || 'medium',
                textAlign: selectedEl.dataset.letterTextAlign || 'center'
            });
        }

        function setLetterFontSize(size, btn) {
            const sizes = { 'small': '16px', 'medium': '20px', 'big': '26px' };
            const textarea = document.getElementById('letterText');
            if (textarea) {
                textarea.style.fontSize = sizes[size];
                textarea.dataset.fontSize = size;
            }
            btn.parentElement.querySelectorAll('.letter-ctrl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setLetterAlign(align, btn) {
            const textarea = document.getElementById('letterText');
            if (textarea) {
                textarea.style.textAlign = align;
                textarea.dataset.textAlign = align;
            }
            btn.parentElement.querySelectorAll('.letter-ctrl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleSidebar() { /* Sidebar removed */ }
        function toggleStylesMenu(forceOpen) {
            if (!stylesMenu) return;
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !stylesMenu.classList.contains('active');
            stylesMenu.classList.toggle('active', shouldOpen);
            if (shouldOpen) addMenu.classList.remove('active');
        }
        function setCanvasBg(color, btn) {
            canvas.style.background = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            btn.classList.add('active');
            if (isMobileViewport()) scheduleViewportFit();
        }

        function toggleAddMenu(forceOpen) {
            if (!addMenu) return;
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !addMenu.classList.contains('active');
            addMenu.classList.toggle('active', shouldOpen);
            if (shouldOpen) stylesMenu.classList.remove('active');
        }

        function bindFloatingControls() {
            const onAddToggle = (event) => {
                event.preventDefault();
                event.stopPropagation();
                toggleAddMenu();
            };
            const onStylesToggle = (event) => {
                event.preventDefault();
                event.stopPropagation();
                toggleStylesMenu();
            };
            const onButtonKey = (event, action) => {
                if (event.key !== 'Enter' && event.key !== ' ') return;
                action(event);
            };

            if (addToggleBtn) {
                addToggleBtn.addEventListener('click', onAddToggle);
                addToggleBtn.addEventListener('keydown', (event) => onButtonKey(event, onAddToggle));
            }

            if (stylesToggleBtn) {
                stylesToggleBtn.addEventListener('click', onStylesToggle);
                stylesToggleBtn.addEventListener('keydown', (event) => onButtonKey(event, onStylesToggle));
            }

            document.addEventListener('click', (event) => {
                const target = event.target;
                if (addMenu && addMenu.classList.contains('active') && !addMenu.contains(target) && (!addToggleBtn ||
                    !addToggleBtn.contains(target))) {
                    toggleAddMenu(false);
                }
                if (stylesMenu && stylesMenu.classList.contains('active') && !stylesMenu.contains(target) && (!stylesToggleBtn
                    || !stylesToggleBtn.contains(target))) {
                    toggleStylesMenu(false);
                }
            });
        }

        function showStatusToast(message) {
            const existing = document.querySelector('.status-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'status-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 180);
            }, 1800);
        }

        function getEventClientPoint(event) {
            if (event.touches && event.touches.length) return { x: event.touches[0].clientX, y: event.touches[0].clientY };
            if (event.changedTouches && event.changedTouches.length) return { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
            return { x: event.clientX, y: event.clientY };
        }

        function startDrag(e, el) {
            const isTouch = !!(e.touches || e.changedTouches);
            if (isTouch) e.preventDefault();
            isDragging = true; select(el);
            dragMoved = false;
            document.body.style.cursor = 'var(--cursor-drag), grabbing';
            canvas.style.cursor = 'var(--cursor-drag), grabbing';
            const p0 = getEventClientPoint(e);
            startPos = { x: p0.x, y: p0.y };
            startElPos = { x: parseInt(el.style.left), y: parseInt(el.style.top) };
            const move = (evt) => {
                if (isTouch) evt.preventDefault();
                const p = getEventClientPoint(evt);
                const dx = (p.x - startPos.x) / currentZoom;
                const dy = (p.y - startPos.y) / currentZoom;
                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) dragMoved = true;
                el.style.left = (startElPos.x + dx) + 'px';
                el.style.top = (startElPos.y + dy) + 'px';
            };
            const end = () => {
                isDragging = false;
                suppressOpenOnce = dragMoved;
                document.body.style.cursor = '';
                canvas.style.cursor = '';
                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);
                window.removeEventListener('touchcancel', end);
                saveCanvas();
            };
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchmove', move, { passive: false });
            window.addEventListener('touchend', end, { passive: false });
            window.addEventListener('touchcancel', end, { passive: false });
        }

        function startResize(e, el) {
            const isTouch = !!(e.touches || e.changedTouches);
            if (isTouch) e.preventDefault();
            e.stopPropagation(); isResizing = true;
            const p0 = getEventClientPoint(e);
            startPos = { x: p0.x, y: p0.y };
            startElPos = { w: el.offsetWidth, h: el.offsetHeight };
            const move = (evt) => {
                if (isTouch) evt.preventDefault();
                const p = getEventClientPoint(evt);
                const dx = (p.x - startPos.x) / currentZoom;
                el.style.width = (startElPos.w + dx) + 'px';
                el.style.height = (startElPos.h + (p.y - startPos.y) / currentZoom) + 'px';
            };
            const end = () => {
                isResizing = false; window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);
                window.removeEventListener('touchcancel', end);
                saveCanvas();
                if (isMobileViewport()) scheduleViewportFit();
            };
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchmove', move, { passive: false });
            window.addEventListener('touchend', end, { passive: false });
            window.addEventListener('touchcancel', end, { passive: false });
        }

        function startRotate(e, el) {
            if (isMobileViewport()) return;
            e.preventDefault();
            const rect = el.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
            const currentRotation = parseInt(el.dataset.rotation) || 0;

            const move = (e) => {
                const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                const delta = (angle - startAngle) * (180 / Math.PI);
                const newRotation = Math.round(currentRotation + delta);
                el.dataset.rotation = newRotation;
                el.style.transform = `rotate(${newRotation}deg)`;
            };
            const end = () => {
                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);
                saveCanvas();
                if (isMobileViewport()) scheduleViewportFit();
            };
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function deleteSelected() {
            selectedEl.remove();
            deselect();
            saveCanvas();
            if (isMobileViewport()) scheduleViewportFit();
        }

        const frames = ['none', 'frame-polaroid-pin', 'frame-red-gallery', 'frame-classic-polaroid'];
        function cycleFrame() {
            if (!selectedEl) return;
            let curr = frames.find(f => selectedEl.classList.contains(f)) || 'none';
            let next = frames[(frames.indexOf(curr) + 1) % frames.length];
            selectedEl.classList.remove(...frames.filter(f => f !== 'none'));
            if (next !== 'none') selectedEl.classList.add(next);
            saveCanvas();
        }

        function addImage() {
            fileInput.onchange = (e) => {
                const selectedFile = e.target.files && e.target.files[0];
                if (!selectedFile) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    const src = re.target.result;
                    createImageCanvasElement(src, {
                        x: 300, y: 200, maxWidth: 360, maxHeight: 300, fallbackWidth: 280,
                        fallbackHeight: 220
                    });
                    addMenu.classList.remove('active');
                };
                reader.readAsDataURL(selectedFile);
                e.target.value = '';
            };
            fileInput.value = '';
            fileInput.click();
        }

        function changeBouquet() {
            bouquetInput.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (re) => {
                    document.querySelector('#fixedBouquet img').src = re.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            bouquetInput.click();
        }

        function addSticker(s) {
            const el = createNewElement('sticker', 1400, 800);
            const d = document.createElement('div'); d.className = 'el-content'; d.textContent = s;
            el.appendChild(d);
            addMenu.classList.remove('active');
        }

        function addVideoFile() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'video/*,.mov';
            input.onchange = (e) => {
                const selectedFile = e.target.files && e.target.files[0];
                if (!selectedFile) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    const src = re.target.result;
                    createVideoCanvasElement(src, {
                        x: 300, y: 200, maxWidth: 420, maxHeight: 300, fallbackWidth: 320,
                        fallbackHeight: 180
                    });
                    addMenu.classList.remove('active');
                    closeModal();
                };
                reader.readAsDataURL(selectedFile);
                e.target.value = '';
            };
            input.value = '';
            input.click();
        }

        function addMusicFile() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'audio/*';
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (re) => {
                    const el = createNewElement('music', 300, 400, 280, 80);
                    el.insertAdjacentHTML('beforeend', `<audio class="el-content" src="${re.target.result}" controls style="width:100%"></audio>`);
                    addMenu.classList.remove('active');
                    closeModal();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        function openModal(type, options = {}) {
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            overlay.style.display = 'flex';

            if (type === 'letter') {
                const initialBg = options.bg || '#ff69b4';
                const initialText = options.text || '';
                editingLetterEl = options.element || null;
                content.innerHTML = `
        <div class="letter-editor-fullscreen" id="letterEditorBg" style="background:${initialBg};">
            <!-- Close button -->
            <button
                style="position:absolute; top:16px; left:16px; width:36px; height:36px; border-radius:50%; background:rgba(255,255,255,0.3); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; color:#fff; z-index:10"
                onclick="closeModal()">√¢≈ì‚Ä¢</button>
            <!-- Color dots to change bg -->
            <div class="letter-color-dots" style="position:absolute; top:20px; right:20px;">
                <div class="letter-color-dot" style="background:#ff69b4"
                    onclick="document.getElementById('letterEditorBg').style.background='#ff69b4'"></div>
                <div class="letter-color-dot" style="background:#ff1493"
                    onclick="document.getElementById('letterEditorBg').style.background='#ff1493'"></div>
                <div class="letter-color-dot" style="background:#e91e63"
                    onclick="document.getElementById('letterEditorBg').style.background='#e91e63'"></div>
                <div class="letter-color-dot" style="background:#9c27b0"
                    onclick="document.getElementById('letterEditorBg').style.background='#9c27b0'"></div>
                <div class="letter-color-dot" style="background:#f48fb1"
                    onclick="document.getElementById('letterEditorBg').style.background='#f48fb1'"></div>
                <div class="letter-color-dot" style="background:#ce93d8"
                    onclick="document.getElementById('letterEditorBg').style.background='#ce93d8'"></div>
            </div>
            <!-- Font size & alignment controls on pink bg -->
            <div
                style="position:absolute; bottom:28px; left:50%; transform:translateX(-50%); display:flex; gap:16px; align-items:center; z-index:10;">
                <div
                    style="display:flex; gap:4px; background:rgba(255,255,255,0.15); border-radius:12px; padding:4px; backdrop-filter:blur(4px);">
                    <button type="button"
                        class="letter-ctrl-btn ${(options.fontSize || 'medium') === 'small' ? 'active' : ''}"
                        onclick="setLetterFontSize('small',this)" style="font-size:12px">S</button>
                    <button type="button"
                        class="letter-ctrl-btn ${(options.fontSize || 'medium') === 'medium' ? 'active' : ''}"
                        onclick="setLetterFontSize('medium',this)" style="font-size:14px">M</button>
                    <button type="button"
                        class="letter-ctrl-btn ${(options.fontSize || 'medium') === 'big' ? 'active' : ''}"
                        onclick="setLetterFontSize('big',this)" style="font-size:16px">L</button>
                </div>
                <div
                    style="display:flex; gap:4px; background:rgba(255,255,255,0.15); border-radius:12px; padding:4px; backdrop-filter:blur(4px);">
                    <button type="button"
                        class="letter-ctrl-btn ${(options.textAlign || 'center') === 'left' ? 'active' : ''}"
                        onclick="setLetterAlign('left',this)" title="Left">&#9776;</button>
                    <button type="button"
                        class="letter-ctrl-btn ${(options.textAlign || 'center') === 'center' ? 'active' : ''}"
                        onclick="setLetterAlign('center',this)" title="Center">&#9776;</button>
                    <button type="button"
                        class="letter-ctrl-btn ${(options.textAlign || 'center') === 'right' ? 'active' : ''}"
                        onclick="setLetterAlign('right',this)" title="Right">&#9776;</button>
                </div>
            </div>
            <!-- Letter paper -->
            <div class="letter-paper-card">
                <div class="texture"></div>
                <textarea class="letter-textarea" id="letterText" placeholder="Write something sweet..."
                    style="font-size:${({ 'small': '16px', 'medium': '20px', 'big': '26px' })[options.fontSize || 'medium']}; text-align:${options.textAlign || 'center'}"></textarea>
                <!-- Actions inside the card -->
                <div class="letter-actions" style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
                    <button class="btn-m btn-m-secondary"
                        onclick="document.getElementById('letterText').value=''">Clear</button>
                    <button class="btn-m btn-m-primary" onclick="confirmLetter()">Save Letter</button>
                </div>
            </div>
        </div>
        `;
                const textarea = document.getElementById('letterText');
                if (textarea) textarea.value = initialText;
            } else if (type === 'video') {
                editingLetterEl = null;
                content.innerHTML = `
        <div
            style="background:#fff; padding:32px; border-radius:32px; width:440px; box-shadow:0 20px 60px rgba(0,0,0,0.1)">
            <h3 style="margin-bottom:8px; font-weight:500">Add Video</h3>
            <p style="color:#86868b; font-size:14px; margin-bottom:20px">Upload a file or paste a YouTube link</p>
            <div class="upload-dropzone" id="videoDropzone" onclick="addVideoFile()">
                <div style="font-size:40px; margin-bottom:8px">&#127909;</div>
                <div style="font-weight:500; margin-bottom:4px">Click to upload or drag video here</div>
                <div style="color:#86868b; font-size:13px">MP4, MOV, WebM</div>
            </div>
            <div class="or-divider">or</div>
            <input type="text" id="modalInput" placeholder="Paste YouTube link..."
                style="width:100%; padding:14px; border-radius:14px; border:1px solid #ddd; font-family:inherit">
            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px">
                <button class="btn-m btn-m-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-m btn-m-primary" onclick="confirmGeneric('video')">Embed</button>
            </div>
        </div>
        `;
                setupDropzone('videoDropzone', 'video');
            } else if (type === 'music') {
                editingLetterEl = null;
                content.innerHTML = `
        <div
            style="background:#fff; padding:32px; border-radius:32px; width:440px; box-shadow:0 20px 60px rgba(0,0,0,0.1)">
            <h3 style="margin-bottom:8px; font-weight:500">Add Music</h3>
            <p style="color:#86868b; font-size:14px; margin-bottom:20px">Upload a file or paste a streaming link</p>
            <div class="upload-dropzone" id="musicDropzone" onclick="addMusicFile()">
                <div style="font-size:40px; margin-bottom:8px">&#127925;</div>
                <div style="font-weight:500; margin-bottom:4px">Click to upload or drag audio here</div>
                <div style="color:#86868b; font-size:13px">MP3, WAV, OGG</div>
            </div>
            <div class="or-divider">or</div>
            <input type="text" id="modalInput" placeholder="Paste Spotify, YouTube Music, or other link..."
                style="width:100%; padding:14px; border-radius:14px; border:1px solid #ddd; font-family:inherit">
            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px">
                <button class="btn-m btn-m-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-m btn-m-primary" onclick="confirmGeneric('music')">Embed</button>
            </div>
        </div>
        `;
                setupDropzone('musicDropzone', 'music');
            }
        }

        function setLetterFontSize(size, btn) {
            const textarea = document.getElementById('letterText');
            if (!textarea) return;
            const sizes = { 'small': '16px', 'medium': '20px', 'big': '26px' };
            textarea.style.fontSize = sizes[size];
            textarea.dataset.fontSize = size;
            btn.parentElement.querySelectorAll('.letter-ctrl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setLetterAlign(align, btn) {
            const textarea = document.getElementById('letterText');
            if (!textarea) return;
            textarea.style.textAlign = align;
            textarea.dataset.textAlign = align;
            btn.parentElement.querySelectorAll('.letter-ctrl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setCanvasBg(color, dot) {
            document.body.style.background = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            if (dot) dot.classList.add('active');
            saveCanvas();
        }

        function showStatusToast(msg) {
            let t = document.querySelector('.status-toast');
            if (!t) {
                t = document.createElement('div');
                t.className = 'status-toast';
                document.body.appendChild(t);
            }
            t.textContent = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        function setupDropzone(id, type) {
            const zone = document.getElementById(id);
            if (!zone) return;
            zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => {
                e.preventDefault(); zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    if (type === 'video') handleVideoFile(file);
                    else handleMusicFile(file);
                }
            };
        }

        function handleVideoFile(file) {
            const reader = new FileReader();
            reader.onload = (re) => {
                const src = re.target.result;
                createVideoCanvasElement(src, {
                    x: 1300, y: 800, maxWidth: 420, maxHeight: 300, fallbackWidth: 320,
                    fallbackHeight: 180
                });
                addMenu.classList.remove('active');
            };
            reader.readAsDataURL(file);
            closeModal();
        }

        function handleMusicFile(file) {
            const reader = new FileReader();
            reader.onload = (re) => {
                const el = createNewElement('music', 1300, 800, 280, 80);
                el.insertAdjacentHTML('beforeend', `<audio class="el-content" src="${re.target.result}" controls style="width:100%"></audio>`);
                addMenu.classList.remove('active');
            };
            reader.readAsDataURL(file);
            closeModal();
        }

        function openLetterViewer(text, bgColor, fontSize, textAlign) {
            const viewer = document.getElementById('letterViewer');
            const safeBg = bgColor || '#ff69b4';
            const safeText = escapeHtml(text || '').replace(/\n/g, '<br>');
            const fSize = ({ 'small': '16px', 'medium': '20px', 'big': '26px' })[fontSize || 'medium'];
            const tAlign = textAlign || 'center';
            viewer.innerHTML = `
        <div class="letter-editor-fullscreen" style="background:${safeBg};">
            <button
                style="position:absolute; top:16px; left:16px; width:36px; height:36px; border-radius:50%; background:rgba(255,255,255,0.3); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; color:#fff; z-index:10"
                onclick="closeLetterViewer()">√¢≈ì‚Ä¢</button>
            <div class="letter-paper-card">
                <div class="texture"></div>
                <div class="letter-textarea"
                    style="white-space:pre-wrap; overflow:auto; pointer-events:auto; font-size:${fSize}; text-align:${tAlign}">
                    ${safeText || '<span style="opacity:.45">No letter text</span>'}</div>
            </div>
        </div>
        `;
            viewer.classList.add('active');
        }

        function openMediaViewer(el) {
            const viewer = document.getElementById('mediaViewer');
            if (!viewer || !el) return;
            const mediaNode = el.querySelector('.el-content');
            if (!mediaNode) return;

            let mediaHtml = '';
            if (mediaNode.tagName === 'IMG') {
                mediaHtml = `<img src="${mediaNode.src}" alt="Preview image" />`;
            } else if (mediaNode.tagName === 'VIDEO') {
                mediaHtml = `<video src="${mediaNode.currentSrc || mediaNode.src}" controls autoplay></video>`;
            } else if (mediaNode.tagName === 'IFRAME') {
                mediaHtml = `<iframe src="${mediaNode.src}" allow="${mediaNode.allow || 'autoplay; encrypted-media'}"
            allowfullscreen></iframe>`;
            } else if (mediaNode.tagName === 'AUDIO') {
                mediaHtml = `<audio src="${mediaNode.currentSrc || mediaNode.src}" controls autoplay></audio>`;
            } else {
                return;
            }

            viewer.innerHTML = `
        <div class="media-viewer-card">
            <button class="letter-viewer-close" onclick="closeMediaViewer()">√¢≈ì‚Ä¢</button>
            <div class="media-viewer-body">${mediaHtml}</div>
        </div>
        `;
            viewer.classList.add('active');
        }

        function closeMediaViewer() {
            const viewer = document.getElementById('mediaViewer');
            if (!viewer) return;
            viewer.innerHTML = '';
            viewer.classList.remove('active');
        }

        function closeLetterViewer() {
            document.getElementById('letterViewer').innerHTML = '';
            document.getElementById('letterViewer').classList.remove('active');
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function closeModal() {
            editingLetterEl = null;
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function confirmLetter() {
            const textarea = document.getElementById('letterText');
            if (!textarea) return;
            const text = textarea.value;
            const editorBg = document.getElementById('letterEditorBg');
            const bg = (editorBg && editorBg.style && editorBg.style.background) ? editorBg.style.background : '#ff69b4';
            // Fix: Read from textarea dataset which is updated by setLetterFontSize/Align
            const fontSize = textarea ? (textarea.dataset.fontSize || 'medium') : 'medium';
            const textAlign = textarea ? (textarea.dataset.textAlign || 'center') : 'center';
            const targetLetter = editingLetterEl || (selectedEl && selectedEl.classList.contains('el-letter') ? selectedEl : null);

            if (targetLetter) {
                targetLetter.dataset.letterText = text;
                targetLetter.dataset.letterBg = bg;
                targetLetter.dataset.letterFontSize = fontSize;
                targetLetter.dataset.letterTextAlign = textAlign;
                if (!targetLetter.querySelector('.envelope-view')) {
                    targetLetter.insertAdjacentHTML('beforeend', `<div class="envelope-view"></div>`);
                }
                saveCanvas(true);
                showStatusToast('Letter saved');
                closeModal();
                addMenu.classList.remove('active');
                return;
            }
            const el = createNewElement('letter', 300, 200, 320, 240);
            el.dataset.letterText = text;
            el.dataset.letterBg = bg;
            el.dataset.letterFontSize = fontSize;
            el.dataset.letterTextAlign = textAlign;
            el.insertAdjacentHTML('beforeend', `<div class="envelope-view"></div>`);
            saveCanvas(true);
            showStatusToast('Letter saved');
            closeModal();
            addMenu.classList.remove('active');
        }

        function confirmGeneric(type) {
            const val = document.getElementById('modalInput').value;
            if (!val) return;
            if (type === 'video') {
                const sourceUrl = extractEmbedSourceFromInput(val);
                const videoId = sourceUrl.match(/(?:v=|youtu\.be\/|embed\/)([a-zA-Z0-9_-]+)/);
                if (videoId) {
                    createVideoCanvasElement(`https://www.youtube.com/embed/${videoId[1]}`, {
                        x: 300, y: 200, maxWidth: 420, maxHeight: 300, fallbackWidth: 320, fallbackHeight: 180, embed: true
                    });
                }
            }
            if (type === 'music') {
                const el = createNewElement(type, 300, 200, 320, 200);
                const embed = resolveMusicEmbed(val);
                if (embed) appendEmbedIframe(el, embed.src, embed.allow, false);
            }
            closeModal();
            addMenu.classList.remove('active');
        }

        function createImageCanvasElement(src, options) {
            const imgProbe = new Image();
            imgProbe.onload = () => {
                const fitted = getFittedMediaSize(imgProbe.naturalWidth, imgProbe.naturalHeight, options.maxWidth,
                    options.maxHeight);
                const el = createNewElement('image', options.x, options.y, fitted.width, fitted.height);
                const img = document.createElement('img');
                img.src = src;
                img.className = 'el-content';
                img.style.objectFit = 'contain';
                el.appendChild(img);
            };
            imgProbe.onerror = () => {
                const el = createNewElement('image', options.x, options.y, options.fallbackWidth, options.fallbackHeight);
                const img = document.createElement('img');
                img.src = src;
                img.className = 'el-content';
                img.style.objectFit = 'contain';
                el.appendChild(img);
            };
            imgProbe.src = src;
        }

        function createVideoCanvasElement(src, options) {
            const setVideoElement = (width, height) => {
                const el = createNewElement('video', options.x, options.y, width, height);
                if (options.embed) {
                    appendEmbedIframe(el, src, 'autoplay; encrypted-media', true);
                } else {
                    el.insertAdjacentHTML('beforeend', `
                        <video class="el-content" src="${src}" controls style="width:100%;height:100%;object-fit:contain;border-radius:12px" onloadeddata="this.currentTime=5;"></video>
                        <div class="video-play-btn" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; background: #ff3355; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 51, 85, 0.4); pointer-events: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="white">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </div>
                    `);
                }
            };

            if (options.embed) {
                const fitted = getFittedMediaSize(16, 9, options.maxWidth, options.maxHeight);
                setVideoElement(fitted.width, fitted.height);
                return;
            }

            const probe = document.createElement('video');
            probe.preload = 'metadata';
            probe.onloadedmetadata = () => {
                const fitted = getFittedMediaSize(probe.videoWidth || 16, probe.videoHeight || 9, options.maxWidth,
                    options.maxHeight);
                setVideoElement(fitted.width, fitted.height);
            };
            probe.onerror = () => {
                setVideoElement(options.fallbackWidth, options.fallbackHeight);
            };
            probe.src = src;
        }

        function extractEmbedSourceFromInput(input) {
            const raw = String(input || '').trim();
            const srcMatch = raw.match(/src\s*=\s*["']([^"']+)["']/i);
            if (srcMatch && srcMatch[1]) return srcMatch[1].trim();
            const urlMatch = raw.match(/https?:\/\/[^\s"'<>]+/i);
            if (urlMatch && urlMatch[0]) return urlMatch[0].trim();
            return raw.replace(/^["']|["']$/g, '').trim();
        }

        function resolveMusicEmbed(input) {
            const source = extractEmbedSourceFromInput(input);
            if (!source) return null;

            if (source.includes('spotify.com')) {
                let normalized = source.replace('open.spotify.com/', 'open.spotify.com/embed/');
                if (!normalized.includes('/embed/')) normalized = normalized.replace('spotify.com/', 'spotify.com/embed/');
                // Ensure no double embed
                normalized = normalized.replace('/embed/embed/', '/embed/');
                return {
                    src: normalized,
                    allow: 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture'
                };
            }

            if (source.includes('music.youtube.com') || source.includes('youtube.com') || source.includes('youtu.be')) {
                const videoId = source.match(/(?:v=|youtu\.be\/|embed\/)([\w-]+)/);
                if (videoId && videoId[1]) {
                    return { src: `https://www.youtube.com/embed/${videoId[1]}`, allow: 'autoplay; encrypted-media' };
                }
            }

            return { src: source, allow: 'autoplay; encrypted-media' };
        }

        function appendEmbedIframe(container, src, allow, allowFullscreen) {
            const iframe = document.createElement('iframe');
            iframe.className = 'el-content';
            iframe.src = src;
            iframe.allow = allow || 'autoplay; encrypted-media';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '12px';
            if (allowFullscreen) iframe.allowFullscreen = true;
            container.appendChild(iframe);
        }

        function getFittedMediaSize(sourceWidth, sourceHeight, maxWidth, maxHeight) {
            const safeWidth = Math.max(1, Number(sourceWidth) || 1);
            const safeHeight = Math.max(1, Number(sourceHeight) || 1);
            const scale = Math.min(maxWidth / safeWidth, maxHeight / safeHeight, 1);
            return {
                width: Math.max(140, Math.round(safeWidth * scale)),
                height: Math.max(100, Math.round(safeHeight * scale))
            };
        }



        /* 
           SUPABASE CONFIGURATION 
           (Managed centrally - duplicate declarations removed)
        */


        function getCanvasIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const fromName = params.get('name');
            if (fromName && fromName.trim()) return fromName.trim();
            const fromId = params.get('id');
            return fromId ? fromId.trim() : '';
        }

        // Canvas ID ‚Äî shared through URL when available, otherwise local persistent draft
        function getCanvasId() {
            const urlId = getCanvasIdFromUrl();
            if (urlId) {
                localStorage.setItem('pinkBouquetCanvasId', urlId);
                return urlId;
            }

            let id = localStorage.getItem('pinkBouquetCanvasId');
            if (!id) {
                id = crypto.randomUUID();
                localStorage.setItem('pinkBouquetCanvasId', id);
            }

            // Critical Fix: Sync ID to URL so refresh doesn't lose it
            try {
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('id', id);
                window.history.replaceState({}, '', newUrl);
            } catch (e) {
                console.warn('Could not update URL state:', e);
            }

            return id;
        }

        const canvasId = getCanvasId();
        const localCanvasKey = `pinkBouquetCanvas:${canvasId}`;
        const legacyLocalCanvasKey = 'pinkBouquetCanvas';
        const editorDbName = 'pinkBouquetEditor';
        const editorDbStore = 'canvasSnapshots';

        function openEditorDb() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject(new Error('IndexedDB unavailable'));
                    return;
                }
                const request = window.indexedDB.open(editorDbName, 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains(editorDbStore)) {
                        db.createObjectStore(editorDbStore, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error || new Error('Failed to open IndexedDB'));
            });
        }

        async function saveCanvasToIndexedDb(id, state) {
            const normalized = normalizeCanvasState(state);
            const db = await openEditorDb();
            await new Promise((resolve, reject) => {
                const tx = db.transaction(editorDbStore, 'readwrite');
                const store = tx.objectStore(editorDbStore);
                store.put({ id, state: normalized, elements: normalized.elements, footerText: normalized.footerText, updatedAt: Date.now() });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error || new Error('Failed to save IndexedDB canvas'));
            });
            db.close();
        }

        async function loadCanvasFromIndexedDb(id) {
            const db = await openEditorDb();
            const record = await new Promise((resolve, reject) => {
                const tx = db.transaction(editorDbStore, 'readonly');
                const store = tx.objectStore(editorDbStore);
                const req = store.get(id);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => reject(req.error || new Error('Failed to load IndexedDB canvas'));
            });
            db.close();
            if (!record) return null;
            if (record.state && typeof record.state === 'object') return normalizeCanvasState(record.state);
            if (Array.isArray(record.elements)) return normalizeCanvasState({ elements: record.elements, footerText: record.footerText || '' });
            return null;
        }

        async function loadLatestCanvasFromIndexedDb() {
            const db = await openEditorDb();
            const latestRecord = await new Promise((resolve, reject) => {
                const tx = db.transaction(editorDbStore, 'readonly');
                const store = tx.objectStore(editorDbStore);
                const req = store.openCursor();
                let latest = null;
                req.onsuccess = () => {
                    const cursor = req.result;
                    if (!cursor) {
                        resolve(latest);
                        return;
                    }
                    const value = cursor.value || {};
                    if (!latest || (Number(value.updatedAt) || 0) > (Number(latest.updatedAt) || 0)) {
                        latest = value;
                    }
                    cursor.continue();
                };
                req.onerror = () => reject(req.error || new Error('Failed to scan IndexedDB canvases'));
            });
            db.close();
            if (!latestRecord) return null;
            if (latestRecord.state && typeof latestRecord.state === 'object') {
                return {
                    id: latestRecord.id || '',
                    state: normalizeCanvasState(latestRecord.state)
                };
            }
            if (Array.isArray(latestRecord.elements)) {
                return {
                    id: latestRecord.id || '',
                    state: normalizeCanvasState({ elements: latestRecord.elements, footerText: latestRecord.footerText || '' })
                };
            }
            return null;
        }

        // √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê PERSISTENCE √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê

        const historyStack = [];
        const redoStack = [];
        let isApplyingHistory = false;

        function buildPreviewUrl(id) {
            const url = new URL(window.location.origin);
            const safeId = String(id || '').trim();
            if (safeId) {
                url.pathname = `/${encodeURIComponent(safeId)}`;
            } else {
                url.pathname = '/';
            }
            return url.toString();
        }


        // Removed broken duplicate code for collectCanvasState/saveCanvasNow
        // Relies on simpler implementation later in file.

        function pushHistorySnapshot(snapshot) {
            const serialized = JSON.stringify(snapshot);
            const last = historyStack[historyStack.length - 1];
            if (last && JSON.stringify(last) === serialized) return;
            historyStack.push(JSON.parse(serialized));
            if (historyStack.length > 100) historyStack.shift();
            redoStack.length = 0;
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = historyStack.length <= 1 || isApplyingHistory;
            if (redoBtn) redoBtn.disabled = redoStack.length === 0 || isApplyingHistory;
        }



        function applyCanvasState(state) {
            const normalizedState = normalizeCanvasState(state);
            lastCanvasState = cloneDeep(normalizedState);
            const mode = getLayoutMode();
            const nextElements = normalizedState.elements;
            (contentLayer || canvas).querySelectorAll('.canvas-element').forEach(el => el.remove());
            deselect();

            if (normalizedState.footerText !== undefined) {
                const ftEl = document.getElementById('footerText');
                if (ftEl) ftEl.innerText = normalizedState.footerText;
            }

            if (normalizedState.bgColor) {
                document.body.style.background = normalizedState.bgColor;
                document.querySelectorAll('.color-dot').forEach(dot => {
                    if (dot.style.background === normalizedState.bgColor) dot.classList.add('active');
                    else dot.classList.remove('active');
                });
            }

            let errorCount = 0;
            nextElements.forEach(data => {
                try {
                    const normalized = normalizeElementRecord(data);
                    const resolvedType = normalized.type;
                    const layout = getLayoutForMode(normalized, mode);
                    const el = document.createElement('div');
                    el.className = normalized.classes || `canvas-element el-${resolvedType}`;
                    el.dataset.elementId = normalized.id;
                    el.style.left = layout.left || '0px';
                    el.style.top = layout.top || '0px';
                    el.style.width = layout.width || '';
                    el.style.height = layout.height || '';
                    el.style.zIndex = layout.zIndex || String(zIndexCounter++);
                    el.style.transform = layout.transform || '';
                    el.dataset.rotation = layout.rotation || '0';
                    if (normalized.letterText) el.dataset.letterText = normalized.letterText;
                    if (normalized.letterBg) el.dataset.letterBg = normalized.letterBg;
                    if (normalized.letterFontSize) el.dataset.letterFontSize = normalized.letterFontSize;
                    if (normalized.letterTextAlign) el.dataset.letterTextAlign = normalized.letterTextAlign;

                    // Ensure visibility
                    el.style.display = 'block';
                    if (resolvedType === 'letter') {
                        el.style.display = 'flex';
                    }

                    el.innerHTML = normalized.contentHTML || '';

                    const handle = document.createElement('div');
                    handle.className = 'resize-handle se';
                    handle.innerHTML = `<svg class="control-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>`;
                    handle.onmousedown = (e) => { e.stopPropagation(); startResize(e, el); };
                    handle.ontouchstart = (e) => { e.stopPropagation(); startResize(e, el); };
                    el.appendChild(handle);

                    const rotHandle = document.createElement('div');
                    rotHandle.className = 'rotate-handle';
                    rotHandle.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /><polyline points="17 2 21 3.5 19.5 7.5" /></svg>`;
                    rotHandle.onmousedown = (e) => { e.stopPropagation(); startRotate(e, el); };
                    el.appendChild(rotHandle);

                    el.onmousedown = (e) => {
                        if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') ||
                            e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                        startDrag(e, el);
                    };
                    el.ontouchstart = (e) => {
                        if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') ||
                            e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                        startDrag(e, el);
                    };
                    el.onmouseenter = () => { if (!isDragging && !isResizing) select(el); };

                    attachRotateEdgeTracking(el);
                    attachMediaCloseButton(el);
                    attachMusicDragHandle(el);

                    if (resolvedType === 'image' || resolvedType === 'video') {
                        el.onclick = (e) => {
                            if (isDragging || isResizing) return;
                            if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') ||
                                e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                            if (suppressOpenOnce) { suppressOpenOnce = false; return; }
                            openMediaViewer(el);
                        };
                    }
                    if (resolvedType === 'music') {
                        el.onclick = (e) => {
                            if (isDragging || isResizing) return;
                            if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') ||
                                e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                        };
                    }
                    if (resolvedType === 'letter') {
                        el.onclick = (e) => {
                            if (isDragging || isResizing) return;
                            if (e.target.closest('.resize-handle') || e.target.closest('.rotate-handle') || e.target.closest('.context-bar') ||
                                e.target.closest('.media-close-btn') || e.target.closest('.music-drag-handle')) return;
                            editSelectedLetter();
                        };
                        // NO background on wrapper - envelope.png handles the visual
                        el.style.background = 'transparent';
                        el.style.padding = '0';
                        el.style.borderRadius = '0';
                        el.style.boxShadow = 'none';
                        el.style.display = 'flex';
                        el.style.alignItems = 'center';
                        el.style.justifyContent = 'center';
                    }

                    (contentLayer || canvas).appendChild(el);
                    const z = parseInt(el.style.zIndex) || 10;
                    if (z >= zIndexCounter) zIndexCounter = z + 1;
                } catch (err) {
                    console.error('Failed to render element:', data, err);
                    errorCount++;
                }
            });

            if (errorCount > 0) {
                showStatusToast(`Loaded with ${errorCount} errors (check console)`);
            } else {
                console.log('Canvas state applied successfully');
            }
            lastAppliedLayoutMode = mode;
        }

        function normalizeElementRecord(r) {
            return {
                id: r.id || r.elementId || Date.now().toString(36) + Math.random().toString(36).substr(2),
                type: r.type,
                left: r.left || '0px',
                top: r.top || '0px',
                width: r.width,
                height: r.height,
                zIndex: r.zIndex,
                transform: r.transform,
                rotation: r.rotation,
                contentHTML: r.contentHTML,
                src: r.src,
                classes: r.classes,
                letterText: r.letterText,
                letterBg: r.letterBg,
                letterFontSize: r.letterFontSize,
                letterTextAlign: r.letterTextAlign
            };
        }

        function collectCanvasState() {
            const elements = [];
            const canvasWidth = canvas.offsetWidth || 1000;
            const canvasHeight = canvas.offsetHeight || 800;

            // Helper to convert px to %
            function pxToPercent(pxValue, containerSize) {
                if (!pxValue || pxValue === 'auto' || pxValue === '') return pxValue;
                const num = parseFloat(pxValue);
                if (isNaN(num)) return pxValue;
                return ((num / containerSize) * 100).toFixed(2) + '%';
            }

            document.querySelectorAll('.canvas-element').forEach(el => {
                const type = el.classList.contains('el-image') ? 'image' :
                    el.classList.contains('el-video') ? 'video' :
                        el.classList.contains('el-music') ? 'music' :
                            el.classList.contains('el-letter') ? 'letter' :
                                el.classList.contains('el-sticker') ? 'sticker' : 'unknown';

                const content = {
                    contentHTML: Array.from(el.children)
                        .filter(c => !c.classList.contains('resize-handle') &&
                            !c.classList.contains('rotate-handle') &&
                            !c.classList.contains('context-bar') &&
                            !c.classList.contains('media-close-btn') &&
                            !c.classList.contains('music-drag-handle'))
                        .map(c => c.outerHTML)
                        .join('')
                };

                if (type === 'letter') {
                    content.letterText = el.dataset.letterText;
                    content.letterBg = el.dataset.letterBg;
                    content.letterFontSize = el.dataset.letterFontSize;
                    content.letterTextAlign = el.dataset.letterTextAlign;
                }

                // Convert positions to percentages for responsiveness
                elements.push({
                    id: el.dataset.elementId,
                    type,
                    left: pxToPercent(el.style.left, canvasWidth),
                    top: pxToPercent(el.style.top, canvasHeight),
                    width: pxToPercent(el.style.width, canvasWidth),
                    height: pxToPercent(el.style.height, canvasHeight),
                    zIndex: el.style.zIndex,
                    transform: el.style.transform,
                    rotation: el.dataset.rotation,
                    classes: el.className.replace(/\bselected\b/g, '').replace(/\bedge-hover\b/g, '').replace(/\s+/g, ' ').trim(),
                    ...content
                });
            });

            return {
                elements,
                footerText: document.getElementById('footerText')?.innerText,
                bgColor: canvas.style.background
            };
        }

        let saveTimeout;
        function saveCanvas(forcePublish = false, securityConfig = null) {
            const state = collectCanvasState();
            if (securityConfig) state.security = securityConfig;

            try { localStorage.setItem('pinkBouquetCanvasId', canvasId); } catch (e) { }
            localStorage.setItem(localCanvasKey, JSON.stringify(state.elements));
            saveCanvasToIndexedDb(canvasId, state).catch(e => console.error(e));

            if (forcePublish) {
                saveCanvasNow(securityConfig);
                return;
            }

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveCanvasNow();
            }, 2000);
        }

        async function saveCanvasNow(securityConfig = null) {
            const state = collectCanvasState();

            if (!isApplyingHistory) {
                pushHistorySnapshot(state);
            }
            updateUndoRedoButtons();

            if (securityConfig) state.security = securityConfig;

            if (!supabaseClient) return;

            try {
                const { error } = await supabaseClient
                    .from('canvases')
                    .upsert({
                        id: canvasId,
                        canvas_data: state,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'id' });

                if (error) {
                    console.warn('Supabase save failed:', error.message);
                } else if (securityConfig) {
                    const baseUrl = window.location.origin;
                    const url = `${baseUrl}/${canvasId}`;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(() => showStatusToast('Published! Link copied.'));
                    } else {
                        alert('Published! Link:\n' + url);
                    }
                }
            } catch (err) {
                console.warn('Supabase save failed:', err);
            }
        }

        async function undoAction() {
            if (historyStack.length <= 1 || isApplyingHistory) return;
            const current = historyStack.pop();
            redoStack.push(current);
            const previous = historyStack[historyStack.length - 1];
            if (!previous) return;

            isApplyingHistory = true;
            applyCanvasState(previous);
            await saveCanvasNow();
            isApplyingHistory = false;
            updateUndoRedoButtons();
        }

        async function redoAction() {
            if (redoStack.length === 0 || isApplyingHistory) return;
            const next = redoStack.pop();
            historyStack.push(next);

            isApplyingHistory = true;
            applyCanvasState(next);
            await saveCanvasNow();
            isApplyingHistory = false;
            updateUndoRedoButtons();
        }

        async function restoreCanvas() {
            console.log('restoreCanvas STARTED for ID:', canvasId);
            let restoredState = null;
            try {
                const loaded = await loadCanvasFromIndexedDb(canvasId);
                if (loaded) {
                    restoredState = normalizeCanvasState(loaded);
                    console.log('Restored from IndexedDB');
                }
            } catch (err) {
                console.warn('IndexedDB restore failed, trying localStorage:', (err && err.message) || err);
            }

            if (!restoredState) {
                const saved = localStorage.getItem(localCanvasKey);
                if (saved) {
                    try {
                        restoredState = normalizeCanvasState({ elements: JSON.parse(saved) });
                        console.log('Restored from LocalStorage');
                    } catch (e) { }
                }
                if (!restoredState) {
                    const legacySaved = localStorage.getItem(legacyLocalCanvasKey);
                    if (legacySaved) {
                        try {
                            const legacyElements = JSON.parse(legacySaved);
                            if (Array.isArray(legacyElements)) {
                                restoredState = normalizeCanvasState({ elements: legacyElements });
                                localStorage.setItem(localCanvasKey, JSON.stringify(restoredState.elements));
                            }
                        } catch (e) { }
                    }
                }
            }

            // If there's no explicit URL id and current key has no data,
            // fall back to the most recently edited local canvas snapshot.
            if (!restoredState && !getCanvasIdFromUrl()) {
                try {
                    const latest = await loadLatestCanvasFromIndexedDb();
                    if (latest && latest.state) {
                        restoredState = latest.state;
                        if (latest.id) {
                            try { localStorage.setItem('pinkBouquetCanvasId', latest.id); } catch (e) { }
                        }
                    }
                } catch (err) {
                    console.warn('Latest IndexedDB restore failed:', (err && err.message) || err);
                }
            }

            // Also try Supabase if needed (omitted for brevity unless essential, assuming local/IDB is primary)
            // Added supabase restore logic just in case:
            if (!restoredState && supabaseClient) {
                console.log('Attempting Supabase restore...');
                try {
                    const { data, error } = await supabaseClient
                        .from('canvases')
                        .select('canvas_data')
                        .eq('id', canvasId)
                        .single();

                    if (error) console.error('Supabase fetch error:', error);

                    if (data && data.canvas_data) {
                        restoredState = normalizeCanvasState(data.canvas_data);
                        console.log('Restored from Supabase!');
                    } else {
                        console.log('No data found in Supabase for this ID.');
                    }
                } catch (err) {
                    console.error('Supabase exception:', err);
                }
            } else if (!supabaseClient) {
                console.warn('Skipping Supabase restore: Client not initialized');
            }

            if (restoredState && Array.isArray(restoredState.elements)) {
                console.log('Applying restored state with', restoredState.elements.length, 'elements');
                try { localStorage.setItem(localCanvasKey, JSON.stringify(restoredState.elements)); } catch (e) { }
                try { await saveCanvasToIndexedDb(canvasId, restoredState); } catch (e) { }
            }

            if (restoredState && restoredState.footerText !== null && restoredState.footerText !== undefined) {
                const ftEl = document.getElementById('footerText');
                if (ftEl) ftEl.innerText = restoredState.footerText;
            }

            if (!restoredState || !Array.isArray(restoredState.elements)) {
                pushHistorySnapshot(collectCanvasState());
                updateUndoRedoButtons();
                await stabilizeAndRevealContentLayer();
                return;
            }

            applyCanvasState(restoredState);
            pushHistorySnapshot(collectCanvasState());
            updateUndoRedoButtons();
            await stabilizeAndRevealContentLayer();
        }
        async function previewPage() {
            if (!saveShareBtn) return;
            const originalText = saveShareBtn.textContent;
            saveShareBtn.disabled = true;
            saveShareBtn.textContent = 'Saving...';

            try {
                await saveCanvasNow();

                const previewUrl = buildPreviewUrl(canvasId);
                let copied = false;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(previewUrl);
                        copied = true;
                    } catch (error) {
                        copied = false;
                    }
                }

                showStatusToast(copied ? 'Saved. Preview link copied.' : 'Saved.');
            } catch (error) {
                console.error('Save failed:', error);
                showStatusToast('Save failed. Please try again.');
            } finally {
                saveShareBtn.disabled = false;
                saveShareBtn.textContent = originalText;
            }
        }

        window.onkeydown = (e) => {
            const isInput = e.target.tagName === 'INPUT' || e.target.contentEditable === 'true';
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z' && !isInput) {
                e.preventDefault();
                if (e.shiftKey) redoAction();
                else undoAction();
                return;
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y' && !isInput) {
                e.preventDefault();
                redoAction();
                return;
            }
            if (!selectedEl || isInput) return;
            if (e.key === 'Delete' || e.key === 'Backspace') { deleteSelected(); }
            if (e.key.startsWith('Arrow')) {
                e.preventDefault();
                let dx = e.key === 'ArrowLeft' ? -1 : e.key === 'ArrowRight' ? 1 : 0;
                let dy = e.key === 'ArrowUp' ? -1 : e.key === 'ArrowDown' ? 1 : 0;
                selectedEl.style.left = (parseInt(selectedEl.style.left) + dx) + 'px';
                selectedEl.style.top = (parseInt(selectedEl.style.top) + dy) + 'px';
                saveCanvas();
            }
        };

    </script>
    <script type="module">
        (() => {
            const host = window.location.hostname;
            const isLocalHost = host === 'localhost' || host === '127.0.0.1' || host === '::1' || host.endsWith('.local');
            const forceEnable = new URLSearchParams(window.location.search).get('agentation') === '1';
            const forceDisable = new URLSearchParams(window.location.search).get('agentation') === '0';

            if ((!isLocalHost && !forceEnable) || forceDisable) return;

            const endpoint = 'http://localhost:4747';
            const sessionStorageKey = 'agentation:sessionId';
            const mount = document.createElement('div');
            mount.id = 'agentation-root';
            document.body.appendChild(mount);

            Promise.all([
                import('https://esm.sh/react@18.3.1'),
                import('https://esm.sh/react-dom@18.3.1/client'),
                import('https://esm.sh/agentation@2.2.1?deps=react@18.3.1,react-dom@18.3.1')
            ]).then(([React, ReactDOMClient, AgentationPkg]) => {
                const { createElement } = React;
                const { createRoot } = ReactDOMClient;
                const { Agentation } = AgentationPkg;
                const existingSessionId = localStorage.getItem(sessionStorageKey) || undefined;

                createRoot(mount).render(
                    createElement(Agentation, {
                        endpoint,
                        sessionId: existingSessionId,
                        onSessionCreated: (sessionId) => {
                            localStorage.setItem(sessionStorageKey, sessionId);
                            console.log('Agentation session started:', sessionId);
                        }
                    })
                );
            }).catch((error) => {
                console.error('Agentation failed to initialize:', error);
            });
        })();
    </script>
</body>

</html>